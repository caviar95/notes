éå¸¸å¥½çš„é—®é¢˜ã€‚ä½ å·²ç»è§¦åŠâ€œ**å¤šå­ç³»ç»ŸçŠ¶æ€ç»„åˆåˆæ³•æ€§ç”Ÿæˆ**â€çš„æ ¸å¿ƒï¼š
ä¸ä»…ä»…æ˜¯â€œå„å­ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ç»„åˆâ€ï¼Œè¿˜æ¶‰åŠ **æ“ä½œé¡ºåº**ï¼ˆä¹Ÿå°±æ˜¯çŠ¶æ€æµè½¬çš„è·¯å¾„ä¾èµ–ï¼‰ã€‚
ä¸‹é¢æˆ‘å°†ç³»ç»Ÿæ€§åœ°å¸®ä½ æ¢³ç†æ•´ä¸ªæ€è·¯ï¼Œå¹¶ç»™å‡ºä¸€å¥—â€œå¯è‡ªåŠ¨ç”Ÿæˆåˆæ³•çŠ¶æ€ç»„åˆ / è¯†åˆ«ä¸åˆæ³•çŠ¶æ€â€çš„é€šç”¨æ–¹æ³•ï¼ˆé€‚ç”¨äºæ©ç æˆ–æšä¸¾ä¸¤ç§å®ç°ï¼‰ã€‚

---

## ğŸ§© èƒŒæ™¯å®šä¹‰

å‡è®¾ç³»ç»Ÿç”±å¤šä¸ª**å­ç³»ç»Ÿï¼ˆSubsystemï¼‰**ç»„æˆï¼š

```
System = Sub1 Ã— Sub2 Ã— Sub3 Ã— ...
```

æ¯ä¸ªå­ç³»ç»Ÿéƒ½æœ‰ä¸€ç»„çŠ¶æ€ï¼ˆé€šå¸¸å¯åˆ†ä¸ºä¸‰ç±»ï¼‰ï¼š

| ç±»å‹                     | å«ä¹‰                                     |
| ---------------------- | -------------------------------------- |
| ç¨³å®šçŠ¶æ€ (Stable)          | æ“ä½œå®Œæˆåçš„ç¨³æ€ï¼Œå¦‚ `READY`ã€`RUNNING`ã€`STOPPED` |
| è¿‡ç¨‹çŠ¶æ€ (Transient)       | æ“ä½œè¿›è¡Œä¸­çš„çŠ¶æ€ï¼Œå¦‚ `STARTING`ã€`STOPPING`       |
| å¼‚å¸¸/ç›®æ ‡çŠ¶æ€ (Target/Error) | æœ€ç»ˆç›®æ ‡æˆ–é”™è¯¯çŠ¶æ€ï¼Œå¦‚ `ERROR`, `FINISHED`        |

ä¾‹ï¼š

```cpp
enum class Sub1State { Idle, Starting, Running, Stopping, Error };
enum class Sub2State { Ready, Busy, Done, Error };
```

---

## ğŸ§  é—®é¢˜æ ¸å¿ƒ

> å½“å„å­ç³»ç»Ÿ**æ“ä½œé¡ºåºä¸åŒ**æ—¶ï¼Œç»„åˆçŠ¶æ€åˆæ³•æ€§ä¼šéšæ—¶é—´æ¼”åŒ–ã€‚

ä¾‹å¦‚ï¼š

| æ“ä½œé¡ºåº           | Sub1 çŠ¶æ€  | Sub2 çŠ¶æ€  | ç³»ç»Ÿæ˜¯å¦åˆæ³•           |
| -------------- | -------- | -------- | ---------------- |
| å¯åŠ¨é¡ºåº Sub1â†’Sub2 | Starting | Ready    | âœ… åˆæ³•ï¼ˆç³»ç»Ÿåœ¨å¯åŠ¨æµç¨‹ï¼‰    |
| å¯åŠ¨é¡ºåº Sub2â†’Sub1 | Ready    | Starting | âŒ ä¸åˆæ³•ï¼ˆè¿èƒŒè§„å®šå¯åŠ¨é¡ºåºï¼‰  |
| è¿è¡ŒçŠ¶æ€           | Running  | Busy     | âœ… åˆæ³•             |
| åœæ­¢é¡ºåºé”™è¯¯         | Stopping | Ready    | âŒ ä¸åˆæ³•ï¼ˆåº”å…ˆåœæ­¢ Sub2ï¼‰ |

---

## ğŸš¦ æ–¹æ³•ä¸€ï¼šåŸºäºâ€œæ“ä½œåºåˆ—â€ç”Ÿæˆåˆæ³•çŠ¶æ€ç©ºé—´

è¿™ç§æ–¹æ³•ä»**æ“ä½œåºåˆ—**å‡ºå‘ï¼Œè‡ªåŠ¨æ¨å¯¼åˆæ³•ç»„åˆã€‚

### Step 1ï¸âƒ£ å®šä¹‰å­ç³»ç»ŸçŠ¶æ€å›¾

æ¯ä¸ªå­ç³»ç»Ÿå®šä¹‰è‡ªå·±çš„**æœ‰é™çŠ¶æ€æœº**ï¼ˆFSMï¼‰ï¼š

```cpp
Sub1:
  Idle â†’ Starting â†’ Running â†’ Stopping â†’ Idle

Sub2:
  Ready â†’ Busy â†’ Done â†’ Ready
```

### Step 2ï¸âƒ£ å®šä¹‰ç³»ç»Ÿæ“ä½œåºåˆ—ï¼ˆå…¨å±€çº¦æŸï¼‰

ä¾‹å¦‚ï¼š

```
å¯åŠ¨æµç¨‹ï¼š Sub1.Start â†’ Sub2.Start
åœæ­¢æµç¨‹ï¼š Sub2.Stop â†’ Sub1.Stop
```

æˆ‘ä»¬å°†è¿™ç§é¡ºåºç”¨**æœ‰å‘ä¾èµ–å›¾ï¼ˆDAGï¼‰**è¡¨ç¤ºï¼š

```
Start:  Sub1 â†’ Sub2
Stop:   Sub2 â†’ Sub1
```

### Step 3ï¸âƒ£ ä»æ‰€æœ‰çŠ¶æ€ç»„åˆç”Ÿæˆâ€œç¬›å¡å°”ç§¯â€

```cpp
AllCombos = {Sub1State Ã— Sub2State}
```

### Step 4ï¸âƒ£ éå†ç»„åˆï¼Œä½¿ç”¨**åˆæ³•è·¯å¾„æ£€æŸ¥å™¨**ç­›é€‰

é€šè¿‡åˆ¤æ–­è¯¥ç»„åˆæ˜¯å¦å¯èƒ½å‡ºç°åœ¨åˆæ³•çš„æ‰§è¡Œè·¯å¾„ä¸Šã€‚

ä¼ªä»£ç ï¼š

```cpp
bool isLegal(Sub1State s1, Sub2State s2) {
    // 1. æ£€æŸ¥å­ç³»ç»Ÿå„è‡ªçŠ¶æ€æ˜¯å¦åœ¨åˆæ³•è·¯å¾„ä¸Š
    if (!isValidState(Sub1_FSM, s1) || !isValidState(Sub2_FSM, s2))
        return false;

    // 2. æ£€æŸ¥å…¨å±€æ“ä½œé¡ºåºçº¦æŸ
    if (s1 == Starting && s2 == Ready)
        return true;  // å¯åŠ¨é˜¶æ®µï¼Œç¬¦åˆ Sub1â†’Sub2 é¡ºåº
    if (s1 == Running && s2 == Busy)
        return true;
    if (s1 == Stopping && s2 == Done)
        return true;

    // 3. è¿èƒŒé¡ºåºçš„åœºæ™¯
    if (s1 == Ready && s2 == Starting)
        return false; // å¯åŠ¨é¡ºåºåäº†

    return false;
}
```

### Step 5ï¸âƒ£ è‡ªåŠ¨ç”Ÿæˆåˆæ³•çŠ¶æ€è¡¨

ä½ å¯ä»¥é€šè¿‡éå†æ‰€æœ‰ç»„åˆï¼š

```cpp
for (auto s1 : all(Sub1State)) {
  for (auto s2 : all(Sub2State)) {
    if (isLegal(s1, s2)) {
        legal_combos.push_back({s1, s2});
    } else {
        illegal_combos.push_back({s1, s2});
    }
  }
}
```

è¾“å‡ºå³å¯å½¢æˆ PPT/æŠ¥å‘Šç”¨è¡¨æ ¼ã€‚

---

## ğŸ§® æ–¹æ³•äºŒï¼šåŸºäºæ©ç çš„é«˜æ•ˆåˆæ³•æ€§æ£€æµ‹

å½“ç³»ç»Ÿå¤šè¾¾ **N ä¸ªå­ç³»ç»Ÿ** æ—¶ï¼Œå…¨ç»„åˆä¸º `Î  |SubiState|`ï¼Œçˆ†ç‚¸å¼å¢é•¿ã€‚
å¯ä»¥ç”¨ **æ©ç  + å±‚çº§æ˜ å°„** æ¥é™ä½å¤æ‚åº¦ã€‚

### æ ¸å¿ƒæ€è·¯

* ä¸ºæ¯ä¸ªå­ç³»ç»Ÿåˆ†é…ä¸€ä¸ªæ©ç æ®µï¼Œå¦‚ï¼š

  ```
  Sub1: bits [0..3]
  Sub2: bits [4..7]
  Sub3: bits [8..11]
  ```
* æ¯ç§çŠ¶æ€æ˜ å°„ä¸ºå›ºå®šæ©ç å€¼ï¼ˆä¾‹å¦‚ç”¨ ID è¡¨ç¤ºï¼‰ã€‚

ä¾‹å¦‚ï¼š

```cpp
constexpr uint32_t Sub1_Idle      = 0x01;
constexpr uint32_t Sub1_Starting  = 0x02;
constexpr uint32_t Sub1_Running   = 0x04;
constexpr uint32_t Sub1_Stopping  = 0x08;
```

### åˆæ³•æ€§è§„åˆ™å¯ä»¥ç”¨æ©ç è¡¨è¾¾

```cpp
constexpr uint32_t Legal_Start_Phase1 = Sub1_Starting | Sub2_Ready;
constexpr uint32_t Legal_Start_Phase2 = Sub1_Running  | Sub2_Busy;
constexpr uint32_t Legal_Stop_Phase1  = Sub1_Stopping | Sub2_Done;
```

é€šè¿‡ bit åŒ¹é…åˆ¤æ–­ï¼š

```cpp
bool isLegal(uint32_t combo_mask) {
    return any_of(legal_masks.begin(), legal_masks.end(),
                  [&](uint32_t legal){ return (combo_mask & legal) == legal; });
}
```

è¿™æ ·å¯ä»¥å¿«é€Ÿåˆ¤å®šã€‚

---

## ğŸ§± æ–¹æ³•ä¸‰ï¼šè·¯å¾„ç”Ÿæˆ + åˆæ³•çŠ¶æ€è‡ªåŠ¨æ¨å¯¼ï¼ˆæ¨èï¼‰

è¿™æ˜¯ä¸€ç§æœ€è‡ªåŠ¨åŒ–ã€æœ€æ˜“æ‰©å±•çš„æ–¹æ¡ˆï¼š

1. å®šä¹‰æ‰€æœ‰å­ç³»ç»Ÿ FSMã€‚
2. å®šä¹‰å…¨å±€æ“ä½œåºåˆ—ï¼ˆé¡ºåºçº¦æŸï¼‰ã€‚
3. ä½¿ç”¨ç®—æ³•ï¼ˆDFS/BFSï¼‰ä»åˆå§‹ç»„åˆå‡ºå‘ï¼Œ**æ¨¡æ‹Ÿæ‰€æœ‰åˆæ³•æ“ä½œåºåˆ—**ã€‚
4. æŠŠèƒ½åˆ°è¾¾çš„ `(Sub1State, Sub2State, ...)` è®°ä¸ºåˆæ³•ç»„åˆã€‚
5. å…¶ä»–ä¸ºéæ³•ã€‚

ä¼ªä»£ç ç¤ºä¾‹ï¼š

```cpp
struct Combo { Sub1State s1; Sub2State s2; };

std::set<Combo> legal;

void dfs(Combo current) {
    legal.insert(current);

    for (auto next : nextStates(current)) {
        if (checkGlobalOrder(current, next))
            dfs(next);
    }
}
```

ç»“æœï¼š

* `legal` é›†åˆä¸­åŒ…å«æ‰€æœ‰**å¯èƒ½å‡ºç°åœ¨çœŸå®è¿è¡Œè¿‡ç¨‹ä¸­çš„ç»„åˆ**
* å‰©ä½™ç»„åˆè‡ªåŠ¨è§†ä¸ºéæ³•

è¿™æ ·ï¼Œæ–°å¢çŠ¶æ€æˆ–ä¿®æ”¹é¡ºåºæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡ç®—åˆæ³•ç©ºé—´ï¼Œ**ä¸ä¼šé—æ¼**ã€‚

---

## âš™ï¸ å®é™…å·¥ç¨‹åº”ç”¨å»ºè®®

| æ–¹æ¡ˆ         | ç‰¹ç‚¹       | é€‚ç”¨åœºæ™¯         |
| ---------- | -------- | ------------ |
| æ–¹æ³•1ï¼šé™æ€è§„åˆ™åŒ¹é… | ç›´è§‚ã€æ˜“å±•ç¤º   | å­ç³»ç»Ÿå°‘ï¼Œæµç¨‹å›ºå®š    |
| æ–¹æ³•2ï¼šæ©ç ç»„åˆ   | é«˜æ•ˆæŸ¥è¯¢     | è¿è¡Œæ—¶é¢‘ç¹çŠ¶æ€æ ¡éªŒ    |
| æ–¹æ³•3ï¼šè·¯å¾„æœç´¢   | è‡ªåŠ¨æ¨å¯¼ã€æœ€å¥å£® | å¤§è§„æ¨¡å¤šå­ç³»ç»Ÿï¼Œå¤æ‚ä¾èµ– |

---

## ğŸ“˜ ä¸¾ä¾‹è¾“å‡ºï¼ˆå¯ç”¨äº PPTï¼‰

| Sub1 çŠ¶æ€  | Sub2 çŠ¶æ€  | é˜¶æ®µ   | åˆæ³•æ€§ | è¯´æ˜     |
| -------- | -------- | ---- | --- | ------ |
| Idle     | Ready    | åˆå§‹   | âœ…   | åˆå§‹ç¨³æ€   |
| Starting | Ready    | å¯åŠ¨é˜¶æ®µ | âœ…   | å¯åŠ¨é¡ºåºæ­£ç¡® |
| Ready    | Starting | å¯åŠ¨é˜¶æ®µ | âŒ   | å¯åŠ¨é¡ºåºé”™è¯¯ |
| Running  | Busy     | è¿è¡Œä¸­  | âœ…   | æ­£å¸¸è¿è¡Œ   |
| Stopping | Done     | åœæ­¢é˜¶æ®µ | âœ…   | åœæ­¢é¡ºåºæ­£ç¡® |
| Done     | Stopping | åœæ­¢é˜¶æ®µ | âŒ   | åœæ­¢é¡ºåºåäº† |

---

## ğŸ’¡ æ‰©å±•æ€è€ƒ

* ä½ å¯ä»¥è¿›ä¸€æ­¥åœ¨åˆæ³•æ€§åˆ¤æ–­ä¸­åŠ å…¥ï¼š

  * **æ—¶é—´çº¦æŸ**ï¼ˆå¦‚ Sub2 å¿…é¡»åœ¨ Sub1 å¯åŠ¨å®Œæˆå 2s å†…è¿›å…¥ Busyï¼‰
  * **ä¼˜å…ˆçº§çº¦æŸ**ï¼ˆå¦‚ç´§æ€¥åœæ­¢å¯è·³è¿‡éƒ¨åˆ†çŠ¶æ€ï¼‰
  * **å­ç³»ç»Ÿç»„**ï¼ˆå¤šä¸ªå­ç³»ç»Ÿä¸€èµ·å½¢æˆ higher-level group FSMï¼‰

---

## âœ… æ€»ç»“

> **å¤šå­ç³»ç»ŸçŠ¶æ€ç»„åˆåˆæ³•æ€§** å¯ä»¥é€šè¿‡ â€œè·¯å¾„çº¦æŸ + çŠ¶æ€ç©ºé—´è£å‰ªâ€ è‡ªåŠ¨ç”Ÿæˆã€‚

ä¸‰ç§æ ¸å¿ƒå®ç°ç­–ç•¥ï¼š

1. **åŸºäºè§„åˆ™åŒ¹é…**ï¼ˆå¿«é€Ÿç›´è§‚ï¼‰
2. **åŸºäºæ©ç åŒ¹é…**ï¼ˆé€‚åˆè¿è¡Œæ—¶éªŒè¯ï¼‰
3. **åŸºäºè·¯å¾„ç”Ÿæˆ**ï¼ˆé€‚åˆè®¾è®¡éªŒè¯/è‡ªåŠ¨æ¨å¯¼ï¼‰

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

* ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ **C++ demo**ï¼ˆå®ç° DFS è‡ªåŠ¨ç”Ÿæˆåˆæ³•çŠ¶æ€ç»„åˆï¼‰
* å¹¶é™„å¸¦è¾“å‡ºè¡¨æ ¼ï¼ˆCSV / Markdownï¼‰å½¢å¼ï¼Œç”¨äº PPT æŠ¥å‘Šã€‚

è¦æˆ‘å¸®ä½ ç”Ÿæˆè¿™ä¸ª demo å—ï¼Ÿ
