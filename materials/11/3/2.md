éå¸¸å¥½ï¼Œè¿™ä¸ªé—®é¢˜åˆ‡ä¸­è¦å®³ ğŸ‘ã€‚
ä½ æåˆ°çš„ **â€œçŠ¶æ€è½¬æ¢æ—¶æŒ‰æ—¢å®šé¡ºåºæ‰§è¡Œä¸€ç³»åˆ—å¤„ç†â€** â€”â€” æœ¬è´¨ä¸Šæ˜¯ **transition pipelineï¼ˆè½¬æ¢ç®¡çº¿ï¼‰** æˆ– **entry sequenceï¼ˆè¿›å…¥åºåˆ—ï¼‰** çš„æ¦‚å¿µã€‚

è€Œä½ æåˆ°çš„åº“ **[hfsm2](https://github.com/andrew-gresyk/HFSM2)** æ˜¯ä¸€ä¸ª **åˆ†å±‚çŠ¶æ€æœºæ¡†æ¶ï¼ˆHierarchical Finite State Machineï¼‰**ï¼Œ
å®ƒç¡®å®å¯ä»¥å®ç°è¿™ä¸€è¡Œä¸ºï¼Œä½†**ä¸æ˜¯ç›´æ¥å†…ç½®â€œç®¡çº¿æœºåˆ¶â€**ï¼Œè€Œæ˜¯é€šè¿‡å…¶ **ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆentry/exit/update/transition hooksï¼‰** å’Œ **å­çŠ¶æ€å±‚æ¬¡ç»“æ„** æ¥**è‡ªç„¶è¡¨è¾¾æœ‰åºå¤„ç†**ã€‚

æˆ‘ä»¬ä¸‹é¢æ¥ç³»ç»Ÿåˆ†æï¼š

---

# ğŸ§© ä¸€ã€hfsm2 çš„å®šä½

`hfsm2` ä¸»è¦ç›®æ ‡æ˜¯ï¼š

* é«˜æ€§èƒ½ï¼ˆé›¶åŠ¨æ€åˆ†é…ã€é›¶è™šå‡½æ•°ï¼‰
* å±‚æ¬¡åŒ–ï¼ˆSubstates / Regionsï¼‰
* æ”¯æŒæ‰‹åŠ¨æˆ–è‡ªåŠ¨åˆ‡æ¢
* æä¾› `enter()`, `update()`, `exit()` é’©å­

**å®ƒä¸ç›´æ¥å®šä¹‰â€œè½¬æ¢è¿‡ç¨‹æœ‰å¤šä¸ªæ­¥éª¤â€**ï¼Œ
ä½†å¯ä»¥ç”¨ **å±‚æ¬¡åŒ–çŠ¶æ€åµŒå¥—** æˆ– **ä¸­é—´çŠ¶æ€é“¾å¼è½¬æ¢** è¡¨è¾¾â€œé¡ºåºæ‰§è¡Œæ­¥éª¤â€ã€‚

---

# ğŸ§  äºŒã€ä½ è¦çš„â€œæœ‰åºæ­¥éª¤è½¬æ¢â€ vs hfsm2çš„æœºåˆ¶

å‡è®¾éœ€æ±‚æ˜¯ï¼š

> Idle â†’ Running æ—¶ï¼Œéœ€è¦æ‰§è¡Œæ­¥éª¤ï¼š
> â‘  æ£€æŸ¥èµ„æº
> â‘¡ åˆå§‹åŒ–
> â‘¢ è½½å…¥é…ç½®
> â‘£ å¯åŠ¨ä»»åŠ¡

åœ¨ hfsm2 é‡Œï¼Œé€šå¸¸æœ‰ä¸¤ç§å®ç°è·¯å¾„ï¼š

---

## âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨**ä¸­é—´çŠ¶æ€é“¾ï¼ˆIntermediate State Chainï¼‰**

æ¯ä¸ªæ­¥éª¤ç”¨ä¸€ä¸ªç‹¬ç«‹å­çŠ¶æ€è¡¨ç¤ºï¼Œè®©çŠ¶æ€æœºè‡ªç„¶æ‰§è¡Œé¡ºåºï¼š

```cpp
struct Idle : hfsm2::State {};

struct Preparing : hfsm2::State {
    void enter(Control& control) noexcept override {
        std::cout << "Check resources\n";
        // æ‰§è¡ŒæˆåŠŸåè·³è½¬åˆ°ä¸‹ä¸€æ­¥
        control.changeTo<Initializing>();
    }
};

struct Initializing : hfsm2::State {
    void enter(Control& control) noexcept override {
        std::cout << "Initialize\n";
        control.changeTo<LoadingConfig>();
    }
};

struct LoadingConfig : hfsm2::State {
    void enter(Control& control) noexcept override {
        std::cout << "Load config\n";
        control.changeTo<Starting>();
    }
};

struct Starting : hfsm2::State {
    void enter(Control& control) noexcept override {
        std::cout << "Start task\n";
        control.changeTo<Running>();
    }
};

struct Running : hfsm2::State {
    void enter(Control&) noexcept override {
        std::cout << "Now running\n";
    }
};
```

å®šä¹‰æ ¹çŠ¶æ€æœºï¼š

```cpp
using FSM = hfsm2::Machine::PeerRoot<
    Idle,
    Preparing,
    Initializing,
    LoadingConfig,
    Starting,
    Running
>;
```

è¿è¡Œï¼š

```cpp
FSM fsm;
fsm.changeTo<Preparing>();
fsm.update();
```

è¾“å‡ºï¼š

```
Check resources
Initialize
Load config
Start task
Now running
```

â¡ï¸ **å®ç°æ•ˆæœç­‰ä»·äºâ€œæŒ‰æ—¢å®šé¡ºåºæ‰§è¡Œå¤šä¸ªæ­¥éª¤â€**ã€‚
åªæ˜¯è¿™äº›æ­¥éª¤ä»¥çŠ¶æ€çš„å½¢å¼å­˜åœ¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°é‡Œçš„æµæ°´çº¿ã€‚

---

## âœ… æ–¹å¼äºŒï¼šä½¿ç”¨å•çŠ¶æ€ + å†…éƒ¨é˜¶æ®µæœºï¼ˆSubstate Pipelineï¼‰

ä½ ä¹Ÿå¯ä»¥ç”¨åµŒå¥—çŠ¶æ€ï¼ˆSubstate Machineï¼‰æ„å»ºä¸€ä¸ªâ€œè¿›å…¥ Running çš„å­æµç¨‹â€ï¼š

```cpp
struct PrepareFSM : hfsm2::Machine::PeerRoot<
    struct CheckResource,
    struct Init,
    struct LoadConfig,
    struct Start
> {};

struct CheckResource : PrepareFSM::State {
    void enter(Control& control) noexcept override {
        std::cout << "CheckResource\n";
        control.changeTo<Init>();
    }
};
struct Init : PrepareFSM::State {
    void enter(Control& control) noexcept override {
        std::cout << "Init\n";
        control.changeTo<LoadConfig>();
    }
};
struct LoadConfig : PrepareFSM::State {
    void enter(Control& control) noexcept override {
        std::cout << "LoadConfig\n";
        control.changeTo<Start>();
    }
};
struct Start : PrepareFSM::State {
    void enter(Control& control) noexcept override {
        std::cout << "Start\n";
        // é€šçŸ¥ä¸Šå±‚
        control.changeTo<Running>();
    }
};

struct Running : hfsm2::State {
    void enter(Control&) noexcept override {
        std::cout << "Running!\n";
    }
};
```

ç„¶ååœ¨ä¸»çŠ¶æ€æœºé‡ŒåµŒå…¥ï¼š

```cpp
using FSM = hfsm2::Machine::CompositeRoot<
    struct Idle,
    struct Preparing,
    Running
>;

struct Preparing : FSM::State {
    using Sub = PrepareFSM;
    Sub subFSM;

    void enter(Control&) noexcept override { subFSM.changeTo<CheckResource>(); }
    void update(FullControl& control) noexcept override {
        subFSM.update();
        if (/* å­FSMå®Œæˆ */) {
            control.changeTo<Running>();
        }
    }
};
```

è¿™ç§æ–¹å¼å¯ä»¥ï¼š

* æŠŠå¤æ‚çš„â€œå‡†å¤‡é˜¶æ®µâ€æ‰“åŒ…æˆç‹¬ç«‹å­çŠ¶æ€æœºï¼›
* å†…éƒ¨æŒ‰æ­¥éª¤æ‰§è¡Œï¼›
* å®Œæˆåè‡ªåŠ¨åˆ‡æ¢åˆ° `Running`ã€‚

è¿™å®é™…ä¸Šå°±æ˜¯åœ¨ hfsm2 ä¸­å®ç°â€œ**çŠ¶æ€è¿›å…¥æ—¶æ‰§è¡Œä¸€ä¸ªæœ‰åºç®¡çº¿**â€ã€‚

---

# ğŸ”© ä¸‰ã€hfsm2 æä¾›çš„è¾…åŠ©æœºåˆ¶

| åŠŸèƒ½                                     | è¯´æ˜                |
| -------------------------------------- | ----------------- |
| `enter()` / `exit()`                   | åœ¨çŠ¶æ€åˆ‡å…¥ / é€€å‡ºæ—¶æ‰§è¡Œé€»è¾‘   |
| `update()`                             | æ¯å¸§æˆ–å‘¨æœŸæ‰§è¡Œé€»è¾‘ï¼Œå¯æ£€æµ‹å¼‚æ­¥äº‹ä»¶ |
| `react(Event&)`                        | å“åº”å¤–éƒ¨äº‹ä»¶ï¼ˆæ¶ˆæ¯é©±åŠ¨ï¼‰      |
| `control.changeTo<T>()`                | åˆ‡æ¢åˆ°æŒ‡å®šçŠ¶æ€           |
| `control.succeed()` / `control.fail()` | åœ¨å¤åˆçŠ¶æ€ä¸­è¡¨ç¤ºé˜¶æ®µå®Œæˆ/å¤±è´¥   |
| `control.resume()`                     | ç»§ç»­ä¸Šæ¬¡æš‚åœçš„çŠ¶æ€         |

è¿™äº› API å¯ä»¥ç»„æˆå¤æ‚çš„â€œè¿‡ç¨‹çŠ¶æ€é“¾â€ã€‚
ä¾‹å¦‚å¼‚æ­¥åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥åœ¨ `update()` ä¸­ç­‰å¾…ä»»åŠ¡å®Œæˆå†åˆ‡æ¢ä¸‹ä¸€æ­¥ã€‚

---

# ğŸ§® å››ã€æ¯”è¾ƒï¼šhfsm2 vs æ‰‹å†™ pipeline

| ç‰¹æ€§           | hfsm2            | æ‰‹å†™ pipeline     |
| ------------ | ---------------- | --------------- |
| é¡ºåºæ‰§è¡Œæ­¥éª¤       | âœ… ç”¨å­çŠ¶æ€æˆ–ä¸­é—´çŠ¶æ€å®ç°    | âœ… pipeline é¡ºåºæ•°ç»„ |
| å¯è§†åŒ–å±‚æ¬¡ç»“æ„      | âœ…ï¼ˆå¤©ç„¶åˆ†å±‚ï¼‰          | âŒ éœ€è¦äººå·¥ç»´æŠ¤        |
| ä»£ç å¤ç”¨ï¼ˆçŠ¶æ€ç‹¬ç«‹é€»è¾‘ï¼‰ | âœ…                | éƒ¨åˆ†æ”¯æŒ            |
| å¼‚æ­¥ç­‰å¾…         | âœ… å¯åœ¨ update() æ§åˆ¶ | âœ… éœ€ç”¨ future æˆ–å›è°ƒ |
| è°ƒè¯• & æ—¥å¿—      | âœ… æ”¯æŒå¯é€‰å®è¾“å‡º        | âœ… æ‰‹åŠ¨æ‰“å°          |
| è¿è¡Œæ—¶æ‰©å±•        | âŒ é™æ€ç¼–è¯‘ç»“æ„         | âœ… åŠ¨æ€æ³¨å†Œå¯é…ç½®       |
| æ€§èƒ½           | âœ… æ— è™šå‡½æ•°/å †åˆ†é…       | âš™ï¸ å–å†³äºå®ç°        |

ğŸŸ¢ **å¦‚æœä½ çš„çŠ¶æ€åºåˆ—è¾ƒå›ºå®šã€ç¼–è¯‘æ—¶å·²çŸ¥**ï¼ˆä¾‹å¦‚è®¾å¤‡å¯åŠ¨æµç¨‹ã€åˆå§‹åŒ–é˜¶æ®µï¼‰ï¼Œ
â†’ **hfsm2 æ›´ä¼˜é›…ä¸”å®‰å…¨ã€‚**

ğŸŸ¡ **å¦‚æœæ­¥éª¤åŠ¨æ€å˜åŒ–æˆ–é…ç½®åŒ–ï¼ˆå¦‚è„šæœ¬é©±åŠ¨ï¼‰**ï¼Œ
â†’ **è‡ªå®šä¹‰ pipeline æ›´çµæ´»ã€‚**

---

# ğŸ’¡ äº”ã€å®æˆ˜å»ºè®®

âœ… å¦‚æœä½ ç›®å‰çš„çŠ¶æ€è½¬æ¢åºåˆ—æ˜¯**å›ºå®šé€»è¾‘é“¾æ¡**ï¼ˆå¦‚â€œå‡†å¤‡â†’å¯åŠ¨â†’è¿è¡Œâ€ï¼‰ï¼Œ
ç›´æ¥åœ¨ `hfsm2` ä¸­ç”¨â€œå­çŠ¶æ€ä¸²è”â€å³å¯ã€‚

âœ… å¦‚æœçŠ¶æ€è½¬æ¢éœ€è¦ï¼š

* åŠ¨æ€å†³å®šæ‰§è¡Œå“ªäº›æ­¥éª¤ï¼›
* æ­¥éª¤å¯èƒ½é‡è¯•/è·³è¿‡ï¼›
* æœ‰å¤–éƒ¨é…ç½®æˆ– UI æ§åˆ¶ï¼›
  åˆ™å»ºè®®ç”¨ **â€œå¤–éƒ¨ pipeline è°ƒç”¨ hfsm2 çŠ¶æ€åˆ‡æ¢â€** çš„æ··åˆæ¨¡å¼ï¼š

```cpp
// Pipeline è´Ÿè´£æ§åˆ¶é€»è¾‘
pipeline.runSteps();
fsm.changeTo<Running>();
```

---

# ğŸ§­ å…­ã€æ€»ç»“

| èƒ½åŠ›              | hfsm2 æ”¯æŒæ–¹å¼             |
| --------------- | ---------------------- |
| é¡ºåºæ‰§è¡Œå¤šæ­¥éª¤è½¬æ¢       | âœ… é€šè¿‡å¤šå±‚çŠ¶æ€é“¾å¼åˆ‡æ¢           |
| è¿›å…¥/é€€å‡ºé’©å­         | âœ… `enter() / exit()`   |
| å¼‚æ­¥ç­‰å¾…            | âœ… åœ¨ `update()` æ§åˆ¶æˆ–äº‹ä»¶ååº” |
| è‡ªå®šä¹‰ pipeline æ‰§è¡Œ | âš™ï¸ éœ€è‡ªè¡Œå°è£…æˆ–ç”¨å¤–å±‚é€»è¾‘         |

æ‰€ä»¥ç»“è®ºï¼š

> ğŸŸ¢ **hfsm2 èƒ½å®ç°â€œè½¬æ¢æ—¶ä¾æ¬¡æ‰§è¡Œæ­¥éª¤â€çš„è¡Œä¸ºï¼Œä½†æ˜¯é€šè¿‡å±‚æ¬¡åŒ–çŠ¶æ€å»ºæ¨¡ï¼Œè€Œéæ˜¾å¼çš„ pipeline ç®¡çº¿æœºåˆ¶ã€‚**
> ğŸŸ¢ **å¦‚æœè½¬æ¢æµç¨‹æ˜¯å›ºå®šé¡ºåºï¼Œhfsm2 å¤©ç„¶æ”¯æŒï¼›å¦‚æœè¦åŠ¨æ€é…ç½®æˆ–è¿è¡Œæ—¶ç”Ÿæˆæ­¥éª¤ï¼Œå»ºè®®åœ¨å¤–éƒ¨åŒ…ä¸€å±‚ pipeline è°ƒåº¦å™¨ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»™å‡ºä¸€ä»½ï¼š

> âœ… â€œhfsm2 + pipeline æ··åˆæ–¹æ¡ˆâ€
> âœ… æ”¯æŒå¼‚æ­¥æ­¥éª¤ã€é‡è¯•ã€æ¡ä»¶è·³è¿‡
> âœ… å¯ç›´æ¥è¿è¡Œçš„ C++ ç¤ºä¾‹

æ˜¯å¦å¸Œæœ›æˆ‘ç”Ÿæˆè¿™ä»½å¢å¼ºç‰ˆå®ç°ï¼Ÿ
