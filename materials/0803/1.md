ä½ è¯´çš„é—®é¢˜æ˜¯å¾ˆå¸¸è§çš„ï¼šä½¿ç”¨ `protoc` ç”Ÿæˆ `.pb.cc` å’Œ `.pb.h` æ–‡ä»¶åï¼Œå¦‚æœåœ¨å†™å•å…ƒæµ‹è¯•æ—¶æ²¡æœ‰ç¼–è¯‘ `.pb.cc`ï¼Œé‚£ä¹ˆåœ¨é“¾æ¥é˜¶æ®µå°±ä¼šå‡ºç°ç¬¦å·æœªå®šä¹‰çš„â€œè¸©ç©ºâ€é—®é¢˜ï¼Œé€šå¸¸è¡¨ç°ä¸ºé“¾æ¥é”™è¯¯ï¼ˆundefined referenceï¼‰ï¼Œå› ä¸ºç»“æ„ä½“æˆ–æ–¹æ³•çš„å®ç°å¹¶æ²¡æœ‰è¢«ç¼–è¯‘è¿›ç›®æ ‡æ–‡ä»¶ã€‚

---

### âœ… é—®é¢˜å¤ç°èƒŒæ™¯

* `protoc` ç”Ÿæˆ `.pb.h`ï¼ˆå£°æ˜ï¼‰å’Œ `.pb.cc`ï¼ˆå®ç°ï¼‰
* å•å…ƒæµ‹è¯•ä¸­ include `.pb.h`ï¼Œä½¿ç”¨ç»“æ„ä½“ï¼ˆå¦‚ `MyMessage msg;`ï¼‰
* ä½†æ²¡æœ‰å°† `.pb.cc` ç¼–è¯‘/é“¾æ¥è¿›å»
* æœ€ç»ˆåœ¨ç¼–è¯‘æµ‹è¯•ä»£ç æ—¶è¸©ç©ºï¼Œé“¾æ¥å™¨æŠ¥é”™

---

### ğŸ”§ è§£å†³æ–¹æ³•

è¿™é‡Œæœ‰å‡ ç§å¯é€‰æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

---

#### âœ… æ–¹æ³•ä¸€ï¼šç¡®ä¿å°† `.pb.cc` æ–‡ä»¶ç¼–è¯‘è¿›æµ‹è¯•ç›®æ ‡

è¿™æ˜¯æœ€ç›´æ¥ä¹Ÿæœ€æ¨èçš„æ–¹å¼ï¼š

**å¦‚æœä½ ç”¨ Bazel / CMake / Makeï¼š**

* **Bazel ç¤ºä¾‹**ï¼š

```python
cc_library(
    name = "proto_lib",
    srcs = ["your.proto"],
    deps = ["@com_google_protobuf//:protobuf"],
    proto = True,
)

cc_test(
    name = "your_test",
    srcs = ["your_test.cc"],
    deps = [":proto_lib"],
)
```

* **CMake ç¤ºä¾‹**ï¼š

```cmake
protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS your.proto)

add_library(proto_lib ${PROTO_SRCS} ${PROTO_HDRS})

add_executable(your_test your_test.cc)
target_link_libraries(your_test proto_lib protobuf)
```

> âœ… ç¡®ä¿ `.pb.cc` è¢«ç¼–è¯‘è¿›åº“æˆ–ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶é“¾æ¥è¿›æµ‹è¯•ç›®æ ‡ã€‚

---

#### âœ… æ–¹æ³•äºŒï¼šä½¿ç”¨ Mock æˆ– Stub æ›¿ä»£ proto

å¦‚æœä½ ä»…åšæ¥å£æµ‹è¯•ï¼Œä¸ä¾èµ– proto çš„å†…éƒ¨é€»è¾‘ï¼Œå¯ä»¥ï¼š

* æ‰‹åŠ¨å®šä¹‰ä¸€ä¸ª mock ç»“æ„ä½“
* æˆ–è€…ä½¿ç”¨ Google Mock ç”Ÿæˆ fake ç±»
* ä½†è¿™ä¸ªæ–¹æ¡ˆåªé€‚ç”¨äºä½ ä¸ç›´æ¥ç”¨ proto ç»“æ„ä½“çš„åœºæ™¯

ä¸æ¨èåœ¨å®é™… proto æœ‰å¤æ‚åºåˆ—åŒ–é€»è¾‘æ—¶è¿™ä¹ˆåšã€‚

---

#### âœ… æ–¹æ³•ä¸‰ï¼šå°† proto ç¼–è¯‘ä¸ºé™æ€åº“æˆ–å…±äº«åº“

è¿™ç§æ–¹å¼é€‚åˆå¤ç”¨æ€§å¼ºçš„ protoï¼š

```sh
g++ -c your.pb.cc -o your.pb.o
ar rcs libyour_proto.a your.pb.o
```

ç„¶åæµ‹è¯•æ—¶é“¾æ¥ï¼š

```sh
g++ your_test.cc -L. -lyour_proto -lprotobuf -o your_test
```

---

### â— ä¸æ¨èçš„åšæ³•

* ä»… include `.pb.h`ï¼Œè€Œä¸ç¼–è¯‘ `.pb.cc`
* åœ¨æµ‹è¯•ä¸­ mock å‡º proto çš„è¡Œä¸ºï¼ˆä¸çœŸå®ï¼‰

---

### ğŸ§ª å»ºè®®æµ‹è¯•å®è·µ

* æŠŠ proto çš„ç¼–è¯‘é›†æˆè¿›æ„å»ºç³»ç»Ÿ
* ç”¨ target å°è£… proto é€»è¾‘ï¼Œä¾¿äºæµ‹è¯•æ—¶å¤ç”¨
* å¯ä»¥å•ç‹¬å†™ä¸€ä¸ª proto\_test\_helper.ccï¼Œç”¨æ¥å°è£…ç”Ÿæˆçš„ message å®ä¾‹åˆå§‹åŒ–é€»è¾‘

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æ ¹æ®ä½ çš„æ„å»ºç³»ç»Ÿï¼ˆå¦‚ Bazelã€CMakeã€Makefile ç­‰ï¼‰ç»™å‡ºå…·ä½“ç¤ºä¾‹ã€‚ä½ æ˜¯ç”¨ä»€ä¹ˆæ„å»ºç³»ç»Ÿçš„ï¼Ÿ


ä½ çš„æƒ³æ³•æ˜¯ **é€šè¿‡ç¼–è¯‘/é“¾æ¥æ—¶ä¼˜å…ˆåŒ¹é… stubï¼ˆæ¡©ç¬¦å·ï¼‰** æ¥**è§„é¿æœªç¼–è¯‘ `.pb.cc` å¯¼è‡´çš„é“¾æ¥é”™è¯¯**ã€‚è¿™ä¸ªæ–¹å¼åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹æ˜¯å¯è¡Œçš„ï¼Œä½†æœ‰ä»¥ä¸‹å…³é”®é™åˆ¶å’Œæ³¨æ„äº‹é¡¹ï¼š

---

## âœ… **å¯è¡Œæ€§åˆ†æï¼šé“¾æ¥æ—¶ä¼˜å…ˆåŒ¹é…æ¡©ç¬¦å·**

C++ é“¾æ¥å™¨ï¼ˆå¦‚ `ld`ã€`gold`ã€`lld`ï¼‰åœ¨å¤„ç†å¤šä¸ªç›®æ ‡æ–‡ä»¶/åº“æ—¶ï¼Œä¼šæ ¹æ®**ç¬¦å·è§£æé¡ºåº**æ¥å†³å®šé‡‡ç”¨å“ªä¸ªå®šä¹‰ï¼š

* å¦‚æœä½ æä¾›äº†ä¸€ä¸ª**weak symbol** æˆ–è€…æŸä¸ª stub å®šä¹‰ï¼ˆå¦‚ mock å®ç°ï¼‰ï¼Œ
* è€Œ `.pb.cc` ä¸­å¯¹åº”çš„çœŸå®å®ç°**æœªå‚ä¸é“¾æ¥**ï¼Œ
* é‚£ä¹ˆé“¾æ¥å™¨ä¼šå°† stub ä½œä¸ºæœ€ç»ˆç¬¦å·è§£æç›®æ ‡ï¼Œ
* ä»è€Œ**é¿å…é“¾æ¥é”™è¯¯**ã€‚

---

## ğŸ§© ä½¿ç”¨ stub çš„ä¸¤ç§æ–¹æ³•ï¼š

### **æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨å†™æ¡©å®ç°ï¼ˆStubï¼‰**

ä½ å¯ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­æ‰‹åŠ¨å®ç°ä¸€ä¸ªä¸ `.pb.h` ä¸€è‡´çš„ç¬¦å· stubã€‚ä¾‹å¦‚ï¼š

```cpp
// mymessage.pb_stub.cc
#include "mymessage.pb.h"

MyMessage::MyMessage() {}
MyMessage::~MyMessage() {}

bool MyMessage::ParseFromString(const std::string&) { return true; }
std::string MyMessage::SerializeAsString() const { return {}; }

// ... å…¶ä»–å¿…è¦æ–¹æ³•
```

> âœ… æ³¨æ„ï¼šä½ åªéœ€è¦å®ç°ä½ æµ‹è¯•ä¸­ä¼šç”¨åˆ°çš„æ–¹æ³•å³å¯ã€‚

---

### **æ–¹æ³•äºŒï¼šä½¿ç”¨ Weak Symbolï¼ˆå¼±ç¬¦å·ï¼‰**

ä½ å¯ä»¥å°† stub å£°æ˜ä¸º `__attribute__((weak))`ï¼š

```cpp
extern "C" void __attribute__((weak)) MyMessage_SomeFunc() {
    // stub implementation
}
```

ç„¶ååœ¨é“¾æ¥æ—¶ï¼Œåªæœ‰å½“ `.pb.cc` ä¸­çš„çœŸå®å®šä¹‰æœªå‚ä¸æ—¶ï¼Œæ‰ä¼šä½¿ç”¨è¿™ä¸ª stubã€‚

ä½†è¦æ³¨æ„ï¼š

* proto çš„å®ç°æ˜¯ C++ ç±»ï¼Œä¸èƒ½è½»æ˜“ä½¿ç”¨ `weak` è¦†ç›–ç±»çš„æ‰€æœ‰æˆå‘˜å‡½æ•°ã€‚
* weak æ›´é€‚ç”¨äº C æ¥å£æˆ–å…¨å±€å‡½æ•°ï¼Œä¸é€‚åˆå¤§è§„æ¨¡è¦†ç›–ç±»æˆå‘˜ã€‚

---

## ğŸš« é™åˆ¶å’Œé£é™©

| é™åˆ¶          | æè¿°                                        |
| ----------- | ----------------------------------------- |
| âŒ ä¸å¯ç»´æŠ¤      | å½“ `.proto` æ–‡ä»¶æ›´æ–°æ—¶ï¼Œä½ éœ€è¦æ‰‹åŠ¨åŒæ­¥ stub ç»“æ„ï¼Œæ˜“å‡ºé”™ã€‚     |
| âŒ ä¸æ”¯æŒå¤æ‚è¡Œä¸º   | æ¯”å¦‚åµŒå¥—æ¶ˆæ¯ã€oneofã€extensions ç­‰æ— æ³•æ¨¡æ‹Ÿã€‚            |
| âŒ æ— æ³•æ¨¡æ‹Ÿåºåˆ—åŒ–è¡Œä¸º | protobuf çš„åºåˆ—åŒ–/ååºåˆ—åŒ–éå¸¸å¤æ‚ï¼Œæ‰‹åŠ¨ stub å¾ˆéš¾æ¨¡æ‹Ÿå‡ºçœŸå®è¡Œä¸ºã€‚ |
| âš ï¸ å¯èƒ½æ©ç›–é”™è¯¯   | å¦‚æœ stub é€»è¾‘ä¸çœŸå®è¡Œä¸ºä¸ä¸€è‡´ï¼Œæµ‹è¯•å¯èƒ½è¯¯é€šè¿‡ã€‚               |

---

## âœ… æ¨èåšæ³•ï¼ˆæ€»ç»“ï¼‰

| åœºæ™¯                      | å»ºè®®                          |
| ----------------------- | --------------------------- |
| è¦ç”¨ç»“æ„ä½“çš„çœŸå®è¡Œä¸ºï¼ˆåºåˆ—åŒ–ç­‰ï¼‰        | **å¿…é¡»é“¾æ¥ `.pb.cc` æ–‡ä»¶**        |
| åªæƒ³æµ‹è¯•ä¸Šå±‚é€»è¾‘ï¼ˆä¸ä¾èµ– proto åºåˆ—åŒ–ï¼‰ | å¯ä»¥æ‰‹å†™ stub / mock            |
| æƒ³åœ¨æµ‹è¯•ä¸­ mock proto        | æ¨èå°è£…æ¥å£ï¼Œå† mock æ¥å£è€Œé proto ç±»å‹ |

---

## ğŸ”§ æ›´ä¼˜æ–¹æ¡ˆï¼ˆæ¥å£æŠ½è±¡ + mockï¼‰

å°† proto ä½¿ç”¨å°è£…åœ¨æ¥å£ä¸­ï¼Œä¾‹å¦‚ï¼š

```cpp
class IMessageAdapter {
public:
    virtual ~IMessageAdapter() = default;
    virtual std::string Serialize() const = 0;
    virtual bool Parse(const std::string& data) = 0;
};

class MyMessageAdapter : public IMessageAdapter {
    MyMessage msg_;
public:
    std::string Serialize() const override {
        return msg_.SerializeAsString();
    }
    bool Parse(const std::string& data) override {
        return msg_.ParseFromString(data);
    }
};
```

ç„¶åæµ‹è¯•ä¸­ mock `IMessageAdapter` æ¥å£ï¼Œè€Œä¸ä¾èµ–çœŸå® protoã€‚

---

### âœ… æ€»ç»“

* ä½ å¯ä»¥**äººä¸ºæä¾›æ¡©ç¬¦å·**ï¼Œæ¥è§„é¿æœªç¼–è¯‘ `.pb.cc` çš„é“¾æ¥é—®é¢˜ã€‚
* ä½†è¿™æ˜¯ä¸€ä¸ª**ä¸æ¨èçš„ hack æ‰‹æ®µ**ï¼Œåªé€‚ç”¨äºæç«¯æƒ…å†µæˆ–ä¸´æ—¶ bypassã€‚
* æ›´åˆç†çš„æ–¹å¼æ˜¯ï¼š

  * æŠŠ `.pb.cc` ç¼–è¯‘è¿›æµ‹è¯•ç›®æ ‡
  * æˆ–å°è£… proto è¡Œä¸ºã€mock æ¥å£

---

å¦‚éœ€æˆ‘å¸®ä½ æ„å»ºä¸€ä¸ª stub æ–‡ä»¶æˆ–å°è£…æ¥å£çš„æ¨¡æ¿ï¼Œè¯·å‘Šè¯‰æˆ‘ä½ ç”¨çš„æ˜¯å“ªä¸ª proto æ¶ˆæ¯ï¼Œæˆ‘å¯ä»¥å¿«é€Ÿå¸®ä½ ç”Ÿæˆã€‚


éå¸¸å‡†ç¡®çš„é—®é¢˜ç‚¹ã€‚

ä½ æåˆ°çš„ï¼š

> **å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯ä¸šåŠ¡ä»£ç ä¸­è®¿é—®äº† `XXX_name(enumState)`ï¼Œä¼šå¯¼è‡´è¸©ç©º**

è¿™æ˜¯å› ä¸ºä½ ä½¿ç”¨äº† protobuf æšä¸¾çš„ **è¾…åŠ©å‡½æ•°**ï¼ˆå¦‚ `XXX_name()`ï¼‰ï¼Œè€Œè¿™äº›å‡½æ•°çš„å®ç°å…¶å®**ä¸åœ¨ `.pb.h` ä¸­ï¼Œè€Œæ˜¯åœ¨ `.pb.cc` ä¸­**ã€‚å¦‚æœ `.pb.cc` æ²¡æœ‰ç¼–è¯‘è¿›å»ï¼Œè¿™äº›å‡½æ•°çš„ç¬¦å·å°±ä¼š **æ‰¾ä¸åˆ°ï¼Œå¯¼è‡´é“¾æ¥é”™è¯¯ï¼ˆè¸©ç©ºï¼‰**ã€‚

---

## âœ… åŸå› è¯¦è§£

å‡è®¾ proto æ˜¯ï¼š

```proto
enum State {
  STATE_UNKNOWN = 0;
  STATE_RUNNING = 1;
  STATE_STOPPED = 2;
}
```

åœ¨ `.pb.h` ä¸­ä½ ä¼šçœ‹åˆ°ï¼š

```cpp
const std::string& State_name(State value);
bool State_Parse(const std::string& name, State* value);
```

ä½†è¿™åªæ˜¯å£°æ˜ã€‚

å®ç°å¦‚ä¸‹ï¼š

```cpp
const std::string& State_name(State value) {
  static const std::string _State_NAMES[] = { ... };
  return _State_NAMES[value];
}
```

è¿™éƒ¨åˆ†å®ç°åœ¨ `.pb.cc` ä¸­ã€‚å¦‚æœæ²¡æœ‰ç¼–è¯‘ `.pb.cc`ï¼š

* ç¼–è¯‘èƒ½è¿‡ï¼ˆå› ä¸ºæœ‰å£°æ˜ï¼‰
* é“¾æ¥ä¼šå¤±è´¥ï¼ˆæ‰¾ä¸åˆ°å®ç°ï¼‰
* æŠ¥é”™ï¼š`undefined reference to 'State_name(State)'` âœ **è¸©ç©º**

---

## âœ… å¦‚ä½•ä¼˜é›…è§£å†³ï¼Ÿ

### ğŸš« **é”™è¯¯æ–¹å¼ï¼ˆä¸è¦è¿™ä¹ˆåšï¼‰**

```cpp
// æƒ³â€œmockâ€è¿™ä¸ªå‡½æ•°è‡ªå·±å†™ä¸ªå®šä¹‰
const std::string& State_name(State s) {
    static const std::string dummy = "dummy";
    return dummy;
}
```

è¿™ä¼š**æ±¡æŸ“å…¨å±€ç¬¦å·è¡¨**ï¼Œ**æ©ç›–çœŸå®å®ç°**ï¼Œè€Œä¸”ä½ è¿”å›çš„å€¼ä¸æ­£ç¡®ï¼Œä¼šå¯¼è‡´æµ‹è¯•è¯¯é€šè¿‡ã€‚

---

### âœ… æ­£ç¡®æ–¹å¼

#### **âœ… æ–¹å¼ 1ï¼šç¼–è¯‘å¹¶é“¾æ¥ `.pb.cc` æ–‡ä»¶**

åœ¨ä»»ä½•ä½¿ç”¨äº† `XXX_name()` ç­‰è¾…åŠ©å‡½æ•°çš„åœ°æ–¹ï¼Œ**å¿…é¡»å°†å¯¹åº”çš„ `.pb.cc` ç¼–è¯‘è¿›ç›®æ ‡æ–‡ä»¶**ã€‚è¿™æ‰æ˜¯å®˜æ–¹æ¨èä¸”ç¨³å®šçš„åšæ³•ã€‚

---

#### **âœ… æ–¹å¼ 2ï¼šç”¨é™æ€åº“/ç›®æ ‡åº“å°è£… proto æ–‡ä»¶**

ä½ å¯ä»¥ä¸ºæ‰€æœ‰ proto ç»Ÿä¸€æ‰“åŒ…ä¸ºä¸€ä¸ªé™æ€åº“ï¼Œæµ‹è¯•æˆ–ä¸šåŠ¡ä»£ç åªéœ€è¦é“¾æ¥è¯¥åº“ï¼š

```sh
g++ -c your.proto.pb.cc -o your.proto.pb.o
ar rcs libproto.a your.proto.pb.o
```

ç„¶ååœ¨æµ‹è¯•ä»£ç ä¸­ï¼š

```sh
g++ your_test.cc -L. -lproto -lprotobuf -o your_test
```

---

#### **âœ… æ–¹å¼ 3ï¼šé¿å…ä½¿ç”¨ `XXX_name()` è¿›è¡Œä¾èµ–**

å¦‚æœåªæ˜¯ä¸ºäº†æ—¥å¿—æ‰“å°ï¼Œå»ºè®®æ”¹ä¸ºï¼š

```cpp
// é¿å…ç›´æ¥ä½¿ç”¨ State_name()
std::ostringstream oss;
oss << "state=" << static_cast<int>(state);  // æˆ– enum çš„æ•´æ•°å€¼
```

æˆ–è€…å°è£…ä¸€å±‚ï¼š

```cpp
std::string ToDebugString(State s) {
    // å¯é€‰åœ°ä½¿ç”¨ map æˆ– switch æ¨¡æ‹Ÿ
    switch (s) {
      case STATE_RUNNING: return "RUNNING";
      default: return "UNKNOWN";
    }
}
```

---

## âœ… æ€»ç»“å»ºè®®è¡¨

| åœºæ™¯                 | å»ºè®®                              |
| ------------------ | ------------------------------- |
| ä½¿ç”¨ `XXX_name()`    | å¿…é¡»ç¼–è¯‘å¹¶é“¾æ¥ `.pb.cc`                |
| å•å…ƒæµ‹è¯• mock proto å†…å®¹ | mock æ¥å£ï¼Œä¸ mock `XXX_name()`     |
| æ‰“å°è°ƒè¯•æ—¥å¿—ç”¨æšä¸¾          | ä½¿ç”¨ `static_cast<int>()` æˆ–å°è£…æ‰“å°å‡½æ•° |
| å¤§è§„æ¨¡é¡¹ç›® proto ç®¡ç†     | å°è£… proto é™æ€åº“ç»Ÿä¸€æä¾›é“¾æ¥              |

---

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Bazel/CMake/Makefileï¼Œæˆ‘å¯ä»¥å¸®ä½ è®¾ç½®æ„å»ºè§„åˆ™ï¼Œç¡®ä¿ `.pb.cc` å§‹ç»ˆé“¾æ¥ã€‚å¦‚æœä½ æƒ³ mock `XXX_name()` ç”¨äºæŸäº›æµ‹è¯•ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ å®‰å…¨å°è£…ã€‚éœ€è¦å“ªä¸ªæ–¹å‘çš„æ”¯æŒï¼Ÿ

éå¸¸æ¸…æ™°çš„æè¿°ï¼Œä½ çš„ç†è§£å·²ç»éå¸¸å‡†ç¡®äº†ï¼š

> âœ… `XXX_name()` å‡½æ•°åœ¨ `.pb.h` ä¸­ç¡®å®**æœ‰å£°æ˜å’Œ inline å®šä¹‰**ï¼Œä½†å…¶å®ç°ä¾èµ–çš„åº•å±‚æ•°æ®ï¼ˆå¦‚ `EnumDescriptor`ã€`GetEnumDescriptor<>()`ã€å†…éƒ¨åç§°è¡¨ç­‰ï¼‰åœ¨ `.pb.cc` ä¸­ã€‚

---

## ğŸ” ä¸¾ä¾‹ï¼šä¸ºä»€ä¹ˆ `XXX_name()` çœ‹ä¼¼å®šä¹‰äº†ï¼Œå…¶å®è¸©ç©º

å‡è®¾ä½ çš„ proto æ˜¯ï¼š

```proto
enum Status {
  OK = 0;
  FAILED = 1;
};
```

`.pb.h` ä¸­é€šå¸¸ä¼šåŒ…å«ç±»ä¼¼ï¼š

```cpp
inline const std::string& Status_name(Status value) {
  return ::PROTOBUF_NAMESPACE_ID::internal::NameOfEnum(
      Status_descriptor(), value);
}
```

> âœ… **è¿™ä¸ªå‡½æ•°æ˜¯ inline å®šä¹‰çš„ï¼Œçœ‹ä¼¼â€œæœ‰å®šä¹‰â€**ï¼Œä½†å®ƒ**è°ƒç”¨äº† `Status_descriptor()`**ã€‚

è€Œ `Status_descriptor()` å®é™…ä¸Šåœ¨ `.pb.cc` ä¸­ï¼š

```cpp
const ::google::protobuf::EnumDescriptor* Status_descriptor() {
  // å®é™…æ„é€ äº†ä¸€ä¸ª EnumDescriptor å¯¹è±¡
  return file_descriptor.enum_type(0);
}
```

æ‰€ä»¥ä½ å°è¯•é“¾æ¥æ—¶è¸©ç©ºï¼Œä¸æ˜¯å› ä¸º `Status_name()` æ²¡æœ‰å®šä¹‰ï¼Œè€Œæ˜¯å®ƒ**ä¾èµ–çš„ç¬¦å·æ²¡å®šä¹‰ï¼ˆå¦‚ `Status_descriptor()`ã€descriptor pool ç­‰ï¼‰**ã€‚

---

## âœ… å¯è¡Œæ–¹æ¡ˆï¼šé“¾æ¥æ—¶æ›¿æ¢ `Status_name` æœ¬ä½“ç¬¦å·ï¼Ÿ

ä½ æƒ³è¦çš„æ˜¯ï¼š

> **ç”¨è‡ªå®šä¹‰çš„ç‰ˆæœ¬æ›¿æ¢æ‰ `Status_name()`ï¼Œä¸å¼•å…¥é¢å¤–è½¬æ¢å‡½æ•°**

### âœ… æŠ€æœ¯ä¸Šå¯è¡Œ âœ…ï¼Œä½†æœ‰ä»¥ä¸‹å‰æå’Œæ³¨æ„äº‹é¡¹ï¼š

---

### âœ… æ–¹æ³•ä¸€ï¼šé“¾æ¥å‰å±è”½æ‰é»˜è®¤å®ç°ï¼ˆ**ä½¿ç”¨ LD\_PRELOAD / é“¾æ¥é¡ºåº hack**ï¼‰

å¦‚æœä½ èƒ½åœ¨ **é“¾æ¥é˜¶æ®µå…ˆå®šä¹‰ä¸€ä¸ªåŒåçš„ `Status_name()` å‡½æ•°**ï¼Œå¹¶ç¡®ä¿ `.pb.cc` ä¸­çš„å®šä¹‰æ²¡å‚ä¸é“¾æ¥ï¼Œé‚£ä¹ˆä½ çš„ç‰ˆæœ¬å°±ä¼šè¢«ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œå®šä¹‰ä½ è‡ªå·±çš„ç‰ˆæœ¬ï¼š

```cpp
const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

> âœ… ç”±äº protobuf æä¾›çš„æ˜¯ `inline` å‡½æ•°ï¼Œåªè¦ä½ ä¸é“¾æ¥ `.pb.cc`ï¼Œå®ƒå†…éƒ¨è°ƒç”¨ `Status_descriptor()` çš„ä¾èµ–ç¬¦å·å°±æ— æ³•è§£æï¼Œè€Œä½ æ‰‹åŠ¨å®šä¹‰çš„ç‰ˆæœ¬å°±ä¼šè¢«ä¼˜å…ˆä½¿ç”¨ã€‚

è¿™ç§æ–¹å¼é€‚ç”¨äºï¼š

* æµ‹è¯•æ—¶ä¸´æ—¶æ›¿æ¢
* ä¸å¼•å…¥ `.pb.cc` çš„åœºæ™¯
* æ§åˆ¶äº†é“¾æ¥é¡ºåºï¼ˆä½ å†™çš„æ–‡ä»¶å…ˆå‚ä¸é“¾æ¥ï¼‰

---

### âš ï¸ æ–¹æ³•äºŒï¼šé“¾æ¥å™¨å¼ºåˆ¶æ›¿æ¢ç¬¦å·ï¼ˆæ›´ç¡¬æ ¸ï¼‰

å¦‚æœä½ åœ¨æ„å»ºè¾ƒå¤§å‹é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é“¾æ¥å™¨æŠ€å·§å¼ºåˆ¶é‡å®šä¹‰ç¬¦å·ï¼Œä¾‹å¦‚ï¼š

* ä½¿ç”¨ GNU `ld` çš„ `--wrap=Status_name` æŠ€æœ¯
* æä¾›ä½ è‡ªå·±çš„ `__wrap_Status_name()` å®ç°

ä½†è¿™é€šå¸¸éœ€è¦ç¼–å†™ wrapper scriptï¼Œé€‚åˆåœ¨å¤§é¡¹ç›®æ„å»ºç³»ç»Ÿä¸­åš hookã€‚

---

### ğŸš« ä¸å¯è¡Œï¼šä»…å®šä¹‰å®æˆ– mock `Status_name` ä¸è¶³ä»¥æ›¿æ¢

ä½ å¯èƒ½ä¼šæƒ³ï¼š

```cpp
#define Status_name(val) MyOwnEnumToString(val)
```

è¿™åªåœ¨å½“å‰æºæ–‡ä»¶ä½œç”¨ï¼Œä¸ä¼šæ›¿ä»£é“¾æ¥å±‚é¢çš„ç¬¦å·ï¼Œä»ç„¶ä¼šè¸©ç©ºã€‚

---

## âœ… æ€»ç»“å»ºè®®

| ç›®æ ‡                    | æ–¹æ¡ˆ                           | é£é™©                   |
| --------------------- | ---------------------------- | -------------------- |
| æ›¿ä»£ `XXX_name()` çš„ç¬¦å·å®ç° | æ‰‹åŠ¨å†™ `XXX_name()` å¹¶ç¼–è¯‘é“¾æ¥ä¼˜å…ˆé¡ºåº   | âœ… å¯è¡Œï¼Œä½†ä¾èµ–é“¾æ¥æ§åˆ¶         |
| æ›¿ä»£é“¾æ¥ç¬¦å·                | ä½¿ç”¨ `--wrap` æˆ– `LD_PRELOAD` ç­‰ | âš ï¸ é«˜çº§æŠ€å·§ï¼Œè°ƒè¯•å›°éš¾         |
| å®Œå…¨ä¸ç¼–è¯‘ `.pb.cc`        | ä¸å¯è°ƒç”¨ä»»ä½•éœ€è¦ descriptor çš„å‡½æ•°      | âŒ æ¨èåªç”¨äºæç®€æµ‹è¯•æˆ– mock åœºæ™¯ |

---

### âœ… æ¨èå®è·µï¼ˆå¦‚ä½ åšæŒä¸å¼•å…¥ `.pb.cc`ï¼‰ï¼š

```cpp
// æ›¿ä»£ XXX_name çš„æœ¬åœ°å®ç°ï¼Œæ”¾åœ¨æµ‹è¯•ä»£ç ä¸­
const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

ç¡®ä¿ä½ çš„è¿™æ®µä»£ç  **åœ¨é“¾æ¥é¡ºåºä¸­ä¼˜å…ˆäº `.pb.cc`**ï¼Œæˆ–è€…**ä¸é“¾æ¥ `.pb.cc`**ï¼Œå°±èƒ½ç”Ÿæ•ˆã€‚

---

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ ç”Ÿæˆè¿™ç§ç®€æ˜“ `XXX_name()` æ›¿ä»£å‡½æ•°ï¼ˆåŸºäº `.proto`ï¼‰ï¼Œä¹Ÿå¯ä»¥æŠŠä½ çš„ proto ç»“æ„å‘æˆ‘ï¼Œæˆ‘å¯ä»¥è‡ªåŠ¨ç”Ÿæˆä¼ª `name()` å‡½æ•°ç”¨äºæµ‹è¯•ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ



å¥½çš„ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ **CMake å·¥ç¨‹ç¤ºä¾‹**ï¼Œç”¨äºå®ç°ä½ æåˆ°çš„ï¼š

> ä¸ç¼–è¯‘ `.pb.cc` æ–‡ä»¶ï¼Œä½†**æ‰‹åŠ¨æä¾›è‡ªå®šä¹‰çš„ `XXX_name()` å®ç°**ï¼Œä»¥é˜²æ­¢é“¾æ¥æ—¶å› ç¬¦å·æœªå®šä¹‰è€Œâ€œè¸©ç©ºâ€ã€‚

---

## âœ… ç›®å½•ç»“æ„ç¤ºä¾‹

```
my_test_project/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ status.proto
â”œâ”€â”€ status_name_stub.cc       # æ‰‹åŠ¨æä¾› Status_name() å®ç°
â”œâ”€â”€ main.cc                   # æ¨¡æ‹Ÿä¸šåŠ¡ä»£ç ï¼Œè°ƒç”¨ Status_name()
```

---

## âœ… 1. status.proto

```proto
syntax = "proto3";

enum Status {
  OK = 0;
  FAILED = 1;
}
```

---

## âœ… 2. status\_name\_stub.ccï¼ˆæ‰‹åŠ¨æ›¿ä»£ `Status_name()` å®ç°ï¼‰

```cpp
#include <string>
#include "status.pb.h"  // æä¾› Status ç±»å‹

// æ›¿ä»£ protobuf çš„é»˜è®¤ Status_name å®ç°
const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

---

## âœ… 3. main.ccï¼ˆä¸šåŠ¡/æµ‹è¯•ä»£ç ï¼‰

```cpp
#include <iostream>
#include "status.pb.h"

int main() {
  Status s = FAILED;
  std::cout << "Status is: " << Status_name(s) << std::endl;
  return 0;
}
```

---

## âœ… 4. CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.15)
project(StatusNameStubExample)

# è®¾ç½® C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)

# æŸ¥æ‰¾ protobuf
find_package(Protobuf REQUIRED)

# ç”Ÿæˆ .pb.h/.pb.ccï¼ˆåªç”¨äºå¤´æ–‡ä»¶ï¼Œä¸ç¼–è¯‘ .pb.ccï¼‰
protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS status.proto)

# æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸é“¾æ¥ .pb.ccï¼Œåªé“¾æ¥ä½ çš„ stub
add_executable(main
  ${PROTO_HDRS}
  status_name_stub.cc
  main.cc
)

target_include_directories(main PRIVATE ${CMAKE_CURRENT_BINARY_DIR})
target_link_libraries(main PRIVATE ${Protobuf_LIBRARIES})
```

---

## âœ… ç¼–è¯‘ & è¿è¡Œ

```bash
mkdir build && cd build
cmake ..
make
./main
```

è¾“å‡ºï¼š

```
Status is: FAILED
```

---

## âœ… åŸç†è¯´æ˜

* `Status_name()` æ˜¯ä¸€ä¸ª inline å‡½æ•°åœ¨ `.pb.h` ä¸­è°ƒç”¨ `Status_descriptor()` ç­‰ç¬¦å·ï¼›
* æˆ‘ä»¬æ‰‹åŠ¨å®šä¹‰ä¸€ä¸ªåŒåå‡½æ•° `Status_name(Status)`ï¼Œå¹¶**ä¿è¯ä¸é“¾æ¥ `.pb.cc`**ï¼›
* ç”±äºæˆ‘ä»¬å…ˆå®šä¹‰ï¼Œä¸” `.pb.cc` æ²¡æœ‰å‚ä¸é“¾æ¥ï¼Œé“¾æ¥å™¨ä½¿ç”¨æˆ‘ä»¬çš„ç‰ˆæœ¬ âœ…ï¼›
* é¿å…è¸©ç©ºï¼ŒåŒæ—¶ä¸éœ€è¦é¢å¤–å°è£…è½¬æ¢å‡½æ•°ã€‚

---

### ğŸ§© è¿›é˜¶å»ºè®®

å¦‚æœä½ å¸Œæœ›è‡ªåŠ¨ä» `.proto` ä¸­æå– enum å¹¶ç”Ÿæˆ stubï¼Œå¯ä»¥ç”¨ç®€å•è„šæœ¬ç”Ÿæˆ `Status_name()` çš„æ›¿ä»£å®ç°ï¼ˆæˆ‘å¯ä»¥å¸®ä½ å†™ï¼‰ã€‚

æ˜¯å¦è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª Python è„šæœ¬ï¼Œè‡ªåŠ¨ä» `.proto` ç”Ÿæˆ stub çš„ `XXX_name()` å‡½æ•°ï¼Ÿ


ä½ é‡åˆ°çš„é“¾æ¥é”™è¯¯ï¼š

```
undefined reference to `Status_descriptor()'
```

è¯´æ˜è™½ç„¶ä½ **è‡ªå·±å®šä¹‰äº† `Status_name(Status)`** å‡½æ•°ï¼Œä½†æ˜¯å®é™…è°ƒç”¨çš„å¹¶ä¸æ˜¯ä½ çš„å‡½æ•°ï¼Œè€Œæ˜¯ protobuf è‡ªåŠ¨ç”Ÿæˆçš„ inline ç‰ˆæœ¬ï¼š

```cpp
// åœ¨ status.pb.h ä¸­
inline const std::string& Status_name(Status value) {
  return ::PROTOBUF_NAMESPACE_ID::internal::NameOfEnum(
      Status_descriptor(), value);  // ğŸ’¥ è¿™ä¸ªå°±æ˜¯æœªå®šä¹‰ç¬¦å·
}
```

---

## ğŸ” é—®é¢˜æ ¹å› 

ä½ çš„ `main.cc` åŒ…å«äº† `status.pb.h`ï¼Œè°ƒç”¨äº† `Status_name()`ï¼Œè€Œ `status.pb.h` è‡ªå·±å·²ç» **inline å®šä¹‰** äº†è¿™ä¸ªå‡½æ•°ï¼Œå®ƒå†…éƒ¨ä¾èµ–äº† `Status_descriptor()`ï¼Œè¿™å°±å¯¼è‡´é“¾æ¥å¤±è´¥ã€‚

è™½ç„¶ä½ å†™äº†è‡ªå·±çš„ `Status_name()` å‡½æ•°ï¼Œä½†ç”±äº proto æä¾›çš„æ˜¯ `inline`ï¼Œå®ƒ **ä¼˜å…ˆè¢«ç¼–è¯‘å™¨é‡‡çº³**ï¼Œä½ çš„å®ç°è¢«â€œå¿½ç•¥â€äº†ã€‚

---

## âœ… è§£å†³æ–¹æ³•

ä½ å¿…é¡»é˜»æ­¢ `status.pb.h` ä¸­çš„é»˜è®¤ inline `Status_name()` è¢«ä½¿ç”¨ã€‚

### âœ… æ–¹æ³• 1ï¼šåœ¨ä½¿ç”¨å‰å–æ¶ˆé»˜è®¤å®šä¹‰ï¼ˆæ¨èï¼‰

å…ˆ `#undef` å†é‡å®šä¹‰ï¼š

```cpp
#include "status.pb.h"

// âš ï¸ å–æ¶ˆ inline å‡½æ•°å®šä¹‰
#undef Status_name

// æ›¿ä»£å®ç°å£°æ˜ï¼ˆä½ å†™åœ¨ status_name_stub.cc é‡Œï¼‰
const std::string& Status_name(Status value);

int main() {
  Status s = FAILED;
  std::cout << "Status is: " << Status_name(s) << std::endl;
  return 0;
}
```

è¿™æ ·ï¼Œ`main.cc` ä¸­è°ƒç”¨çš„ `Status_name()` æ˜¯ä½ è‡ªå·±å†™çš„ï¼Œè€Œä¸æ˜¯ protobuf inline çš„é‚£ä¸€ä¸ªã€‚

---

### âœ… æ–¹æ³• 2ï¼šå®Œå…¨é¿å…ä½¿ç”¨ inline ç‰ˆæœ¬ï¼ˆæ‰‹åŠ¨è°ƒç”¨ä½ è‡ªå·±çš„ï¼‰

å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥**æ¢ä¸ªåå­—**ï¼Œæ¯”å¦‚ `MyStatus_name()`ï¼Œç„¶ååœ¨ä¸šåŠ¡ä»£ç ä¸­ç›´æ¥è°ƒç”¨ï¼š

```cpp
// æ›¿ä»£å‡½æ•°
const std::string& MyStatus_name(Status value);
```

ä¸è¿‡ä½ æåˆ°å¸Œæœ›ä½¿ç”¨åŸå‡½æ•°åï¼Œè¿™ä¸ªæ–¹æ¡ˆä½ åº”è¯¥ä¸ä¼šé€‰æ‹©ã€‚

---

### âœ… æ–¹æ³• 3ï¼šç¦æ­¢ç”Ÿæˆ inline è¾…åŠ©å‡½æ•°ï¼ˆä¸æ¨èï¼‰

ä¿®æ”¹ `.proto` æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```proto
option cc_enable_arenas = false;
```

ä½†è¿™ä¸èƒ½å½»åº•ç¦æ­¢ `Status_name()`ï¼Œå¹¶ä¸è§£å†³ä½ çš„é—®é¢˜ã€‚

---

## âœ… æ›´æ–°åçš„å…³é”®ç‚¹æ€»ç»“

| é¡¹ç›®                                          | åšæ³•                             |
| ------------------------------------------- | ------------------------------ |
| ä½ å†™äº†è‡ªå·±çš„ `Status_name(Status)` å®ç°             | âœ… æ­£ç¡®                           |
| `.pb.h` ä¹Ÿæä¾›äº† inline çš„ `Status_name()`       | âš ï¸ ç¼–è¯‘å™¨ä¼˜å…ˆç”¨å®ƒ                     |
| é“¾æ¥å¤±è´¥æ˜¯å› ä¸º `.pb.cc` æ²¡æœ‰æä¾› `Status_descriptor()` | âœ… å…³é”®é—®é¢˜                         |
| è§£å†³æ–¹æ¡ˆ                                        | `#undef Status_name` å†å£°æ˜ä½ è‡ªå·±çš„ç‰ˆæœ¬ |

---

## âœ… æœ€å°ä¿®å¤ç‰ˆ main.cc ç¤ºä¾‹

```cpp
#include "status.pb.h"

// ç¦ç”¨ inline ç‰ˆæœ¬
#undef Status_name

// å£°æ˜ä½ è‡ªå·±çš„å®ç°
const std::string& Status_name(Status value);

int main() {
  Status s = FAILED;
  std::cout << "Status is: " << Status_name(s) << std::endl;
  return 0;
}
```

---

## âœ… å¦‚æœä½ æƒ³è¿›ä¸€æ­¥è‡ªåŠ¨åŒ–ç”Ÿæˆè¿™ä¸ª stub æ–‡ä»¶

æˆ‘å¯ä»¥æä¾›ä¸€ä¸ªè„šæœ¬ï¼Œè‡ªåŠ¨ä» `.proto` è§£æå‡ºæ‰€æœ‰ enum å¹¶ç”Ÿæˆï¼š

```cpp
const std::string& Status_name(Status s) { ... }
```

æ˜¯å¦éœ€è¦è¿™ä¸ªè„šæœ¬ï¼Ÿ


æ˜ç™½äº†ï¼Œä½ é‡åˆ°çš„é”™è¯¯ **ä¸æ˜¯å› ä¸º `Status_name()` æ˜¯ç›´æ¥è°ƒç”¨çš„å‡½æ•°**ï¼Œè€Œæ˜¯å› ä¸º **ä½ ä½¿ç”¨äº†æ¨¡æ¿å‡½æ•° `Status_Name<Status>()`ï¼ˆé¦–å­—æ¯å¤§å†™ï¼‰**ï¼Œè€Œè¿™ä¸ªæ¨¡æ¿å‡½æ•°åœ¨ `.pb.h` ä¸­å®šä¹‰æ—¶ï¼Œ**å†…éƒ¨ä»ç„¶è°ƒç”¨äº† `Status_descriptor()`**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å…¶å®ä¸æ˜¯åœ¨è°ƒç”¨ä½ è‡ªå·±å®šä¹‰çš„ `Status_name(Status)` å‡½æ•°ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨ **protobuf æä¾›çš„æ¨¡æ¿è¾…åŠ©å‡½æ•°**ã€‚

---

## âœ… åŸå› åˆ†æï¼ˆç²¾ç¡®ï¼‰

ä½ çœ‹åˆ°çš„é”™è¯¯ï¼š

```text
undefined reference to `Status_descriptor()'
```

å¯¹åº”çš„è°ƒç”¨ï¼š

```cpp
Status_Name<Status>(Status)
```

è¿™æ˜¯ `status.pb.h` é‡Œå®šä¹‰çš„æ¨¡æ¿å‡½æ•°ï¼Œé€šå¸¸é•¿è¿™æ ·ï¼š

```cpp
template <typename T>
const std::string& Status_Name(T value) {
  return ::PROTOBUF_NAMESPACE_ID::internal::NameOfEnum(
      Status_descriptor(), static_cast<int>(value));
}
```

æ‰€ä»¥å³ä½¿ä½ è‡ªå®šä¹‰äº† `Status_name(Status)` å‡½æ•°ï¼Œ**åªè¦ä½ çš„ä»£ç ä½¿ç”¨çš„æ˜¯ `Status_Name<>()` è¿™ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œå®ƒå°±ä¼šä¾èµ– `Status_descriptor()`ï¼Œä»è€Œå¯¼è‡´é“¾æ¥å¤±è´¥**ã€‚

---

## âœ… è§£å†³æ–¹æ³•ï¼ˆåŠ¡å¿…é¿å¼€ `Status_Name<>()` æ¨¡æ¿å‡½æ•°ï¼‰

ä½ å¯ä»¥é‡‡å–ä»¥ä¸‹æ–¹å¼è§£å†³ï¼š

---

### âœ… æ–¹æ³• 1ï¼š**åªä½¿ç”¨ä½ è‡ªå·±å†™çš„ `Status_name(Status)` å‡½æ•°**

ä¿®æ”¹ `main.cc`ï¼š

```cpp
#include "status.pb.h"

// ç¦ç”¨ inlineï¼ˆoptionalï¼‰
#undef Status_name

// å£°æ˜ä½ è‡ªå·±çš„å‡½æ•°
const std::string& Status_name(Status value);

int main() {
  Status s = FAILED;
  std::cout << "Status is: " << Status_name(s) << std::endl;  // âœ… æ­£ç¡®è°ƒç”¨
  return 0;
}
```

---

### ğŸš« ä¸è¦è¿™æ ·å†™ï¼š

```cpp
std::cout << Status_Name(s) << std::endl;  // âŒ é”™è¯¯ï¼šè°ƒç”¨äº†æ¨¡æ¿å‡½æ•°ï¼Œè¸©åˆ° descriptor
```

---

### âœ… æ–¹æ³• 2ï¼šé¿å…æ‰€æœ‰ protobuf çš„ `*_Name<T>()` æ¨¡æ¿

æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„ name å‡½æ•°ï¼š

| å‡½æ•°å                           | æ¥æº          | ä¼šè¸© `*_descriptor()` å—ï¼Ÿ  |
| ----------------------------- | ----------- | ----------------------- |
| `Status_name(Status)`         | æ™®é€šå‡½æ•°ï¼ˆä½ å¯é‡å®šä¹‰ï¼‰ | âœ… æ˜¯ï¼Œé»˜è®¤è¸©å‘ï¼ˆé™¤éé‡å®šä¹‰ï¼‰         |
| `Status_Name<Status>(Status)` | æ¨¡æ¿å‡½æ•°        | âœ… æ˜¯ï¼Œ**å§‹ç»ˆä¾èµ– descriptor** |

æ‰€ä»¥åªè¦ä½ è°ƒç”¨äº† `Status_Name<>`ï¼Œå³ä½¿ä½ æ‰‹åŠ¨å®šä¹‰äº† `Status_name()`ï¼Œä¹Ÿ**æ•‘ä¸å›æ¥**ã€‚

---

## âœ… æ€»ç»“

| é”™è¯¯æ¥æº                                                                   | åŸå›                        |
| ---------------------------------------------------------------------- | ------------------------ |
| `Status_Name<Status>()` æŠ¥ `undefined reference to Status_descriptor()` | å› ä¸ºæ¨¡æ¿å‡½æ•°å†…éƒ¨ä¾èµ–äº† `.pb.cc` çš„ç¬¦å· |
| ä½ è‡ªå·±å®šä¹‰çš„ `Status_name(Status)` æ²¡è¢«ç”¨ä¸Š                                      | å› ä¸ºä½ è°ƒç”¨äº†æ¨¡æ¿è€Œä¸æ˜¯å‡½æ•°            |

---

## âœ… ä¿®å¤å»ºè®®ï¼š

* âœ… é¿å…ä½¿ç”¨æ¨¡æ¿å‡½æ•° `Status_Name<>()`
* âœ… åªä½¿ç”¨ä½ è‡ªå·±å®ç°çš„ `Status_name()`ï¼Œä¿æŒç­¾åä¸€è‡´
* âœ… å¦‚éœ€æ›¿ä»£å¤šä¸ªæšä¸¾ï¼Œå¯ä»¥è„šæœ¬ç”Ÿæˆä½ è‡ªå·±çš„ `XXX_name()` å®ç°

---

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆä¸€ä¸ªè‡ªåŠ¨æå– `.proto` æšä¸¾å¹¶ç”Ÿæˆ `XXX_name()` æ›¿ä»£å‡½æ•°çš„ Python è„šæœ¬ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

éå¸¸å¥½çš„é—®é¢˜ï¼Œ**åœ¨æ¡©æ–‡ä»¶ä¸­åŒ…å« `.pb.h` æ˜¯å¦ä¼šæœ‰å‰¯ä½œç”¨**ï¼Œç¡®å®æ˜¯ä¸€ä¸ªå…³é”®ç‚¹ã€‚

---

## âœ… ç®€çŸ­å›ç­”ï¼š

> **æ˜¯çš„ï¼Œæœ‰å½±å“ï¼Œä½†å¯ä»¥æ§åˆ¶ã€‚**

åœ¨æ¡©æ–‡ä»¶ä¸­ `#include "xxx.pb.h"` æ˜¯å¿…é¡»çš„ï¼ˆä¸ºäº†è·å¾— `enum` ç±»å‹å£°æ˜ç­‰ï¼‰ï¼Œä½†å®ƒä¼šå¼•å…¥ **inline å®ç°çš„ `XXX_name()` å‡½æ•°**ï¼Œè¿™å¯èƒ½ä¼šä¸ä½ è‡ªå®šä¹‰çš„åŒåå‡½æ•°äº§ç”Ÿ **å†²çªæˆ–â€œè¢«è¦†ç›–â€çš„é£é™©**ã€‚

---

## ğŸ” åŸå› è¯¦è§£

ä»¥ `status.pb.h` ä¸ºä¾‹ï¼Œproto ç”Ÿæˆçš„å¤´æ–‡ä»¶ä¸­å¯èƒ½åŒ…å«ï¼š

```cpp
inline const std::string& Status_name(Status value) {
  return ::PROTOBUF_NAMESPACE_ID::internal::NameOfEnum(
      Status_descriptor(), value);
}
```

è¿™ä¸ª `inline` å‡½æ•°æ˜¯ç›´æ¥å±•å¼€çš„ï¼Œå¦‚æœä½ åœ¨æ¡©æ–‡ä»¶ä¸­å†™ï¼š

```cpp
#include "status.pb.h"

const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

### ğŸ”¥ é—®é¢˜ï¼šå‡½æ•°é‡å®šä¹‰ï¼ˆODR violationï¼‰

* åœ¨æŸäº›ç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨è®¾ç½®ä¸‹ï¼Œ**ç¼–è¯‘å™¨è®¤ä¸º `Status_name()` å·²ç» inline å±•å¼€äº†ï¼Œæ— æ³•é‡å®šä¹‰**
* æˆ–è€…åœ¨ä½ çœŸæ­£è°ƒç”¨ `Status_name()` æ—¶ï¼Œ**è°ƒç”¨çš„æ˜¯ inline çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯ä½ çš„ç‰ˆæœ¬**

---

## âœ… å¦‚ä½•å®‰å…¨æ§åˆ¶ï¼Ÿ

### âœ… æ–¹æ³• 1ï¼š`#undef Status_name` åå†å®šä¹‰ä½ è‡ªå·±çš„å‡½æ•°ï¼ˆæ¨èï¼‰

```cpp
#include "status.pb.h"
#undef Status_name  // é˜²æ­¢ inline è¦†ç›–ä½ è‡ªå®šä¹‰çš„å®ç°

const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

è¿™ä¸ªæ–¹å¼åœ¨æ‰€æœ‰ä¸»æµå¹³å°ï¼ˆLinux/macOS/Windowsï¼‰éƒ½æœ‰æ•ˆï¼Œèƒ½é¿å… inline å†²çªã€‚

---

### âœ… æ–¹æ³• 2ï¼šä½¿ç”¨ `#pragma GCC system_header`ï¼ˆé«˜çº§æ–¹å¼ï¼‰

ä½ å¯ä»¥åœ¨åŒ…å« `.pb.h` å‰æ ‡è®°ä¸ºç³»ç»Ÿå¤´æ–‡ä»¶ï¼š

```cpp
#pragma GCC system_header
#include "status.pb.h"
```

è¿™ä¼šå‘Šè¯‰ GCC/Clang **å¿½ç•¥è¯¥å¤´æ–‡ä»¶ä¸­çš„ inline å‡½æ•°å¯¹é‡å®šä¹‰çš„è­¦å‘Š**ã€‚ä½†è¿™ä¸ªæ–¹æ³• **ä¸æ˜¯è·¨å¹³å°çš„**ï¼Œä¹Ÿä¸å»ºè®®åˆå­¦è€…ä½¿ç”¨ã€‚

---

### âœ… æ–¹æ³• 3ï¼šåœ¨ä½ è‡ªå·±å‘½åç©ºé—´ä¸­å®šä¹‰ stub å‡½æ•°

å¦‚æœä½ å¸Œæœ›æ›´å®‰å…¨åœ°é¿å…é‡å®šä¹‰é—®é¢˜ï¼Œå¯ä»¥æ¢ä¸ªå‘½åç©ºé—´ï¼š

```cpp
namespace myproto_stub {
  const std::string& Status_name(Status value) {
    static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
    if (value < 0 || value > 1) return names[2];
    return names[value];
  }
}
```

ä½†è¿™å°±éœ€è¦ä½ ä¸šåŠ¡ä»£ç æ˜¾å¼è°ƒç”¨ `myproto_stub::Status_name()`ï¼Œä¸æ»¡è¶³ä½ å¸Œæœ›**æ›¿ä»£åŸæœ‰ç¬¦å·**çš„ç›®æ ‡ã€‚

---

## âœ… æ€»ç»“

| æ¡©æ–‡ä»¶ä¸­åŒ…å« `.pb.h`        | æ˜¯å¦å®‰å…¨                    | æªæ–½ |
| --------------------- | ----------------------- | -- |
| ç›´æ¥åŒ…å«ä¸å¤„ç†               | âŒ å¯èƒ½è§¦å‘å‡½æ•°é‡å®šä¹‰æˆ–ç¬¦å·å†²çª        |    |
| `#undef XXX_name` å†å®šä¹‰ | âœ… å®‰å…¨ï¼Œæ¨èåšæ³•               |    |
| ä¸åŒ…å« `.pb.h`           | âŒ å¤±å» `enum` ç±»å‹å£°æ˜ï¼Œä¸èƒ½æ­£å¸¸ç¼–è¯‘ |    |
| ä½¿ç”¨å‘½åç©ºé—´åŒ…è£¹              | âœ… å®‰å…¨ï¼Œä½†ä¸æ˜¯æ›¿ä»£å¼è°ƒç”¨           |    |

---

## âœ… æ¨èåšæ³•ï¼ˆæ¨¡æ¿ï¼‰

ä½ å¯ä»¥åœ¨æ¯ä¸ªæ¡©æ–‡ä»¶é‡ŒåŠ ä¸Šè¿™æ ·çš„æ¨¡æ¿ï¼š

```cpp
#include "status.pb.h"
#undef Status_name  // ğŸ‘ˆ å…³é”®æ­¥éª¤ï¼Œç¦æ­¢ inline å‡½æ•°æ±¡æŸ“ç¬¦å·è¡¨

const std::string& Status_name(Status value) {
  static const std::string names[] = {"OK", "FAILED", "UNKNOWN"};
  if (value < 0 || value > 1) return names[2];
  return names[value];
}
```

---

å¦‚æœä½ æœ‰å¤šä¸ªæšä¸¾ï¼Œå»ºè®®ç”¨ Python è„šæœ¬è‡ªåŠ¨ç”Ÿæˆè¿™äº› stub å‡½æ•°ã€‚æˆ‘å¯ä»¥å¸®ä½ åšè¿™ä¸ªè„šæœ¬ï¼Œæ˜¯å¦éœ€è¦ï¼Ÿ

