åœ¨ C++ ä¸­é‡åˆ°ç¼–è¯‘é”™è¯¯æˆ–é“¾æ¥é”™è¯¯ä¸­å«æœ‰ `__cxx11` æˆ–ç±»ä¼¼ `[abi:cxx11]` çš„æ ‡å¿—ï¼Œé€šå¸¸æ˜¯**C++ ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ä¸å…¼å®¹**æ‰€å¯¼è‡´çš„é—®é¢˜ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªè¯­æ³•é”™è¯¯ï¼Œè€Œæ˜¯ä¸€ä¸ª**äºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰å±‚é¢çš„ä¸åŒ¹é…**ã€‚

---

## ğŸ” ä»€ä¹ˆæ˜¯ `[abi:cxx11]`ï¼Ÿ

`[abi:cxx11]` æ˜¯ GCCï¼ˆGNU ç¼–è¯‘å™¨ï¼‰ç”¨æ¥æ ‡è®°ä½¿ç”¨ **C++11 ABI** é£æ ¼çš„ç¬¦å·çš„æ–¹å¼ã€‚è‡ª **GCC 5.1 èµ·**ï¼Œä¸ºäº†æ›´å¥½åœ°æ”¯æŒ C++11 çš„æ ‡å‡†åº“ç‰¹æ€§ï¼ˆå¦‚ `std::string`ã€`std::list` ç­‰ï¼‰ï¼ŒGCC æ”¹å˜äº†æ ‡å‡†åº“ç±»å‹ï¼ˆå¦‚ `std::string`, `std::wstring`, `std::list`, `std::unordered_map` ç­‰ï¼‰çš„å†…éƒ¨ç»“æ„ä¸ ABIã€‚

ä¸ºäº†è§£å†³æ–°æ—§ ABI çš„æ··ç”¨é—®é¢˜ï¼ŒGCC ç»™æ–° ABI çš„ç¬¦å·åæ·»åŠ äº†ç‰¹æ®Šæ ‡è®°ï¼Œæ¯”å¦‚ï¼š

```cpp
std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >
```

å®ƒå¯èƒ½ä»¥ `[abi:cxx11]` è¿™ç§å½¢å¼å‡ºç°åœ¨æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç¬¦å·ä½¿ç”¨çš„æ˜¯æ–°çš„ C++11 ABIã€‚

---

## âš ï¸ å¸¸è§æŠ¥é”™ç¤ºä¾‹

```
undefined reference to `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::basic_string()'
```

æˆ–ï¼š

```
undefined reference to symbol 'std::__cxx11::basic_string...'
```

---

## ğŸ§  ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

é€šå¸¸å‘ç”Ÿåœ¨**ä¸åŒç¼–è¯‘å™¨ç‰ˆæœ¬æˆ–ä¸åŒ ABI è®¾ç½®çš„å¯¹è±¡æ–‡ä»¶/åº“æ··ç”¨**æ—¶ï¼š

### ğŸ”¹ åœºæ™¯ä¸€ï¼šæ—§ç‰ˆæœ¬ GCC ç¼–è¯‘çš„åº“ + æ–°ç‰ˆ GCC ç¼–è¯‘çš„ä»£ç 

* æ¯”å¦‚ä½ ç”¨ GCC 4.x ç¼–è¯‘äº†ä¸€ä¸ªåº“ï¼ˆæ²¡æœ‰ `__cxx11` æ ‡å¿—ï¼‰ã€‚
* ç”¨ GCC 9 ç¼–è¯‘çš„ä¸»ç¨‹åºï¼ˆé»˜è®¤å¯ç”¨äº† C++11 ABIï¼‰ï¼Œä¼šå°è¯•é“¾æ¥å¸¦ `__cxx11` çš„ç¬¦å·ã€‚
* ä¸¤è€…ä¸å…¼å®¹ï¼Œä¼šå¯¼è‡´é“¾æ¥å¤±è´¥ã€‚

### ğŸ”¹ åœºæ™¯äºŒï¼šç¬¬ä¸‰æ–¹åº“æœªå¯ç”¨ C++11 ABIï¼Œä½ çš„ä»£ç å¯ç”¨äº†

* å¸¸è§äº prebuilt çš„ `.a` / `.so` æ–‡ä»¶æ¥è‡ªæ—§ç¼–è¯‘å™¨ï¼Œæˆ–å…³é—­äº† `CXX11 ABI`ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### âœ… æ–¹æ³•ä¸€ï¼šç»Ÿä¸€ç¼–è¯‘å™¨ç‰ˆæœ¬ + ABI è®¾ç½®

æœ€å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿**æ‰€æœ‰ä»£ç ä¸ä¾èµ–åº“éƒ½ä½¿ç”¨åŒä¸€ ABI è®¾ç½®**ï¼š

#### å¯¹äº GCC >= 5 çš„é¡¹ç›®ï¼š

* é»˜è®¤å¯ç”¨ C++11 ABIï¼ˆå¸¦ `[abi:cxx11]`ï¼‰

#### å¦‚æœå¿…é¡»å…¼å®¹æ—§ ABIï¼š

ä½ å¯ä»¥**å…³é—­æ–° ABI**ï¼ˆé€€å›æ—§çš„ ABIï¼‰æ¥ä¸æ—§åº“å…¼å®¹ï¼š

```bash
g++ -D_GLIBCXX_USE_CXX11_ABI=0 ...
```

å¦‚æœä½ ç¼–è¯‘çš„æ˜¯åº“ï¼Œä¹Ÿåº”ä½¿ç”¨è¿™ä¸ªå®ã€‚

#### ç›¸ååœ°ï¼Œæƒ³å¼ºåˆ¶ä½¿ç”¨æ–°çš„ ABIï¼š

```bash
g++ -D_GLIBCXX_USE_CXX11_ABI=1 ...
```

> é»˜è®¤å€¼ï¼šGCC 5 ä»¥åæ˜¯ `1`ï¼ˆå¼€å¯æ–° ABIï¼‰

---

## ğŸ§ª å¦‚ä½•æ’æŸ¥ï¼Ÿ

1. æŸ¥çœ‹ `.so` æˆ– `.a` æ˜¯å¦ä½¿ç”¨äº†æ–° ABI

   ```bash
   nm libxxx.a | grep __cxx11
   ```

   å¦‚æœç»“æœä¸­åŒ…å« `__cxx11`ï¼Œè¯´æ˜è¿™ä¸ªåº“ä½¿ç”¨äº†æ–° ABIã€‚

2. æ£€æŸ¥ä½ çš„ä»£ç å’Œåº“æ˜¯å¦ç¼–è¯‘æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ ABI å®ï¼š

   * `_GLIBCXX_USE_CXX11_ABI=1`ï¼ˆæ–°ï¼‰
   * `_GLIBCXX_USE_CXX11_ABI=0`ï¼ˆæ—§ï¼‰

3. ä¿æŒä¸€è‡´å³å¯ã€‚

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

* è¿™ä¸ª ABI é—®é¢˜**ä¸»è¦å½±å“æ ‡å‡†åº“ç±»å‹**ï¼ˆå¦‚ `std::string`ã€`std::list`ï¼‰ã€‚
* è‡ªå®šä¹‰ç±»å‹ã€POD ç±»å‹ä¸å—å½±å“ã€‚
* å½±å“æœ€å¸¸è§çš„æ˜¯ `std::string`ï¼Œå› ä¸ºå®ƒåœ¨ ABI æ›´æ”¹å‰åå®ç°ä¸åŒã€‚
* å°½é‡**é¿å…åœ¨å¤´æ–‡ä»¶ä¸­æš´éœ² `std::string` æ¥å£**ï¼Œå¦‚æœéœ€è¦è€ƒè™‘ ABI ç¨³å®šæ€§ã€‚

---

## âœ… æ€»ç»“

| é—®é¢˜               | åŸå›                    | è§£å†³æ–¹æ³•                           |
| ---------------- | -------------------- | ------------------------------ |
| `[abi:cxx11]` æŠ¥é”™ | ABI ä¸å…¼å®¹ï¼Œæ–°æ—§ C++ æ ‡å‡†åº“æ··ç”¨ | ç»Ÿä¸€ `_GLIBCXX_USE_CXX11_ABI` è®¾ç½® |
| undefined symbol | é“¾æ¥ä¸åˆ°æ­£ç¡®ç¬¦å·ï¼Œå›  ABI æ ‡ç­¾ä¸ä¸€è‡´ | é‡æ–°ç¼–è¯‘åº“æˆ–æºç ï¼Œä½¿ç”¨ä¸€è‡´çš„ ABI è®¾ç½®          |

---

å¦‚æœä½ èƒ½è´´å‡ºå…·ä½“çš„æŠ¥é”™ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥æ›´å…·ä½“åˆ†ææ˜¯å“ªä¸€éƒ¨åˆ† ABI ä¸ä¸€è‡´å¯¼è‡´çš„é“¾æ¥å¤±è´¥ã€‚


å¥½çš„ï¼Œä¸‹é¢æˆ‘æ¥**æ„é€ ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹**ï¼Œæ¼”ç¤ºå¦‚ä½•å› ä¸º `[abi:cxx11]` å¯¼è‡´ C++ é“¾æ¥å¤±è´¥ï¼Œå¹¶ç»™å‡ºè§£å†³æ–¹æ¡ˆã€‚

---

## âœ… åœºæ™¯è¯´æ˜

æˆ‘ä»¬å°†ï¼š

* **ç¼–è¯‘ä¸€ä¸ªé™æ€åº“ libhello.aï¼ˆç”¨æ—§ ABI ç¼–è¯‘ï¼‰**ï¼Œå¯¹å¤–æš´éœ² `std::string` æ¥å£ã€‚
* **ä¸»ç¨‹åº main.cppï¼ˆç”¨é»˜è®¤æ–° ABI ç¼–è¯‘ï¼‰** è°ƒç”¨è¿™ä¸ªåº“ã€‚
* ç„¶åæ¼”ç¤ºå¦‚ä½•å‡ºç° `__cxx11` é”™è¯¯ï¼Œå¹¶ä¸€æ­¥æ­¥è§£å†³ã€‚

---

## ğŸ§± Step 1: åˆ›å»º `hello.h` å’Œ `hello.cpp`

### hello.h

```cpp
#ifndef HELLO_H
#define HELLO_H

#include <string>

std::string getMessage();

#endif // HELLO_H
```

### hello.cpp

```cpp
#include "hello.h"

std::string getMessage() {
    return "Hello, world!";
}
```

---

## ğŸ› ï¸ Step 2: ç¼–è¯‘é™æ€åº“ `libhello.a`ï¼ˆä½¿ç”¨æ—§ ABIï¼‰

æˆ‘ä»¬ä½¿ç”¨æ—§ ABI æ¥ç¼–è¯‘ï¼š

```bash
g++ -c hello.cpp -o hello.o -D_GLIBCXX_USE_CXX11_ABI=0
ar rcs libhello.a hello.o
```

è¿™è¡¨ç¤ºæˆ‘ä»¬ç”¨çš„æ˜¯ **æ—§ ABIï¼ˆ\_GLIBCXX\_USE\_CXX11\_ABI=0ï¼‰** ç¼–è¯‘çš„åº“ã€‚

---

## ğŸ“„ Step 3: åˆ›å»ºä¸»ç¨‹åº `main.cpp`

### main.cpp

```cpp
#include <iostream>
#include "hello.h"

int main() {
    std::cout << getMessage() << std::endl;
    return 0;
}
```

---

## ğŸ”¥ Step 4: ç¼–è¯‘ä¸»ç¨‹åºï¼ˆé»˜è®¤å¼€å¯æ–° ABIï¼‰

```bash
g++ main.cpp -L. -lhello
```

**âš ï¸ é“¾æ¥å¤±è´¥ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š**

```text
undefined reference to `std::__cxx11::basic_string<...> getMessage()'
```

è¿™æ˜¯å› ä¸ºï¼š

* `main.cpp` é»˜è®¤ä½¿ç”¨çš„æ˜¯ **æ–° ABI**ï¼ˆå³ `_GLIBCXX_USE_CXX11_ABI=1`ï¼‰
* è€Œ `libhello.a` æ˜¯ç”¨ **æ—§ ABI** ç¼–è¯‘çš„ï¼ˆå³ `_GLIBCXX_USE_CXX11_ABI=0`ï¼‰

---

## âœ… Step 5: è§£å†³æ–¹æ³•

æˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

---

### âœ… æ–¹æ³•ä¸€ï¼šä¸»ç¨‹åºä¹Ÿä½¿ç”¨æ—§ ABI

```bash
g++ main.cpp -L. -lhello -D_GLIBCXX_USE_CXX11_ABI=0
```

âœ… é“¾æ¥é€šè¿‡ï¼Œè¿è¡Œè¾“å‡ºï¼š

```bash
Hello, world!
```

---

### âœ… æ–¹æ³•äºŒï¼šé‡ç¼– `libhello.a`ï¼Œæ”¹ä¸ºä½¿ç”¨æ–° ABI

é‡æ–°ç¼–è¯‘ hello.o å’Œ libhello.aï¼š

```bash
g++ -c hello.cpp -o hello.o -D_GLIBCXX_USE_CXX11_ABI=1
ar rcs libhello.a hello.o
```

ç„¶åå†ç¼–è¯‘ä¸»ç¨‹åºï¼ˆæ— éœ€é¢å¤–è®¾ç½®ï¼‰ï¼š

```bash
g++ main.cpp -L. -lhello
```

âœ… åŒæ ·æˆåŠŸè¾“å‡ºï¼š

```bash
Hello, world!
```

---

## ğŸ” éªŒè¯ ABI å·®å¼‚

ä½ å¯ä»¥ç”¨ `nm` æŸ¥çœ‹ç¬¦å·æ˜¯å¦å¸¦æœ‰ `__cxx11`ï¼š

```bash
nm libhello.a | c++filt | grep getMessage
```

* ä½¿ç”¨æ–° ABI æ—¶ï¼šçœ‹åˆ° `std::__cxx11::basic_string... getMessage()`
* ä½¿ç”¨æ—§ ABI æ—¶ï¼šçœ‹åˆ° `std::basic_string... getMessage()`

---

## âœ… å°ç»“

| é¡¹ç›®/è¡Œä¸º        | ABI è®¾ç½®æ–¹å¼                     | ç»“æœ                |
| ------------ | ---------------------------- | ----------------- |
| ç¼–è¯‘åº“ç”¨æ—§ ABI    | `-D_GLIBCXX_USE_CXX11_ABI=0` | `std::string` æ—§å½¢å¼ |
| ç¼–è¯‘ä¸»ç¨‹åºç”¨é»˜è®¤ ABI | é»˜è®¤å¼€å¯ï¼ˆå³ `=1`ï¼‰                 | â›” é“¾æ¥å¤±è´¥            |
| ä¸»ç¨‹åºç»Ÿä¸€ä½¿ç”¨æ—§ ABI | `-D_GLIBCXX_USE_CXX11_ABI=0` | âœ… é“¾æ¥æˆåŠŸ            |
| æˆ–è€…åº“é‡ç¼–ä¸ºæ–° ABI  | `-D_GLIBCXX_USE_CXX11_ABI=1` | âœ… é“¾æ¥æˆåŠŸ            |

---

å¦‚æœä½ å¸Œæœ›æˆ‘æ‰©å±•æˆ `.so` åŠ¨æ€åº“ç‰ˆæœ¬ï¼Œæˆ–è€…å†ç”¨ CMake æ„é€ ä¸€ä¸ªå¯å¤ç°çš„é¡¹ç›®ç»“æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­è¡¥å……ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ


å½“ç„¶å¯ä»¥ã€‚ä»¥ä¸‹æ˜¯ä¸€ç¯‡å…³äº\*\*å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPublish-Subscribe Patternï¼‰\*\*çš„æŠ€æœ¯åšå®¢ï¼Œå†…å®¹åŒ…æ‹¬å…¶åŸºæœ¬åŸç†ã€å…¸å‹åº”ç”¨åœºæ™¯ã€å¸¸è§é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Œé€‚åˆæ¶æ„å¸ˆã€åç«¯å·¥ç¨‹å¸ˆæˆ–ç³»ç»Ÿè®¾è®¡çˆ±å¥½è€…é˜…è¯»ã€‚

---

# å‘å¸ƒ-è®¢é˜…æ¨¡å¼æ·±å…¥è§£æï¼šæ¶æ„è§£è€¦çš„åˆ©å™¨ä¸éšè—çš„é™·é˜±

> å‘å¸ƒ-è®¢é˜…ï¼ˆPublish-Subscribeï¼‰æ¨¡å¼æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨äºäº‹ä»¶é©±åŠ¨æ¶æ„ã€æ¶ˆæ¯ç³»ç»Ÿå’Œå¾®æœåŠ¡é€šä¿¡çš„è®¾è®¡æ¨¡å¼ã€‚å®ƒä¼˜é›…åœ°å®ç°äº†\*\*â€œæ—¶é—´è§£è€¦ + ç©ºé—´è§£è€¦ + ä¾èµ–è§£è€¦â€\*\*ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†å¯è§‚æµ‹æ€§å·®ã€æ•…éšœä¼ æ’­ã€æ€§èƒ½ç“¶é¢ˆç­‰æŒ‘æˆ˜ã€‚æœ¬æ–‡å°†å¸¦ä½ ç³»ç»Ÿäº†è§£è¯¥æ¨¡å¼çš„åŸç†ã€ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠå·¥ç¨‹å®è·µä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ€è·¯ã€‚

---

## ä¸€ã€å‘å¸ƒ-è®¢é˜…æ¨¡å¼ç®€ä»‹

### 1.1 åŸºæœ¬æ¦‚å¿µ

å‘å¸ƒ-è®¢é˜…æ˜¯ä¸€ç§**æ¶ˆæ¯é€šä¿¡æ¨¡å¼**ï¼Œå®ƒå°†æ¶ˆæ¯çš„å‘é€è€…ï¼ˆPublisherï¼‰ä¸æ¥æ”¶è€…ï¼ˆSubscriberï¼‰é€šè¿‡\*\*äº‹ä»¶é€šé“ï¼ˆBroker æˆ– Message Busï¼‰\*\*è§£è€¦ï¼š

* **å‘å¸ƒè€…**ï¼šå‘é€äº‹ä»¶æˆ–æ¶ˆæ¯ï¼Œä¸å…³å¿ƒè°ä¼šæ¥æ”¶ã€‚
* **è®¢é˜…è€…**ï¼šæ³¨å†Œå…³æ³¨ç‰¹å®šç±»å‹çš„äº‹ä»¶ã€‚
* **äº‹ä»¶æ€»çº¿ / ä¸­ä»‹è€…**ï¼šè´Ÿè´£å°†æ¶ˆæ¯ä»å‘å¸ƒè€…åˆ†å‘åˆ°æ‰€æœ‰åŒ¹é…çš„è®¢é˜…è€…ã€‚

è¿™ç§æ¨¡å¼çš„æ ¸å¿ƒæ˜¯\*\*â€œè§‚å¯Ÿè€…â€æ¨¡å¼çš„æ‰©å±•ä¸å‡çº§\*\*ã€‚

### 1.2 å›¾ç¤ºæ¨¡å‹

```text
       +------------+
       | Publisher  |
       +------------+
             |
         [å‘å¸ƒäº‹ä»¶]
             â†“
       +------------+
       | Message Bus|
       +------------+
         â†‘        â†‘
     [è®¢é˜…A]   [è®¢é˜…B]
      |            |
+-------------+ +-------------+
| SubscriberA | | SubscriberB |
+-------------+ +-------------+
```

---

## äºŒã€å…¸å‹åº”ç”¨åœºæ™¯

* **å‰ç«¯ UI äº‹ä»¶ç³»ç»Ÿ**ï¼ˆå¦‚ DOM çš„äº‹ä»¶å†’æ³¡ï¼‰
* **å¾®æœåŠ¡è§£è€¦é€šä¿¡**ï¼ˆå¦‚ Kafkaã€RabbitMQã€Redis Pub/Subï¼‰
* **æ¸¸æˆå¼•æ“äº‹ä»¶æœºåˆ¶**
* **åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰**
* **æœåŠ¡æ€»çº¿ï¼ˆESBï¼‰**

---

## ä¸‰ã€å‘å¸ƒ-è®¢é˜…çš„ä¼˜åŠ¿

| ä¼˜ç‚¹   | æè¿°                    |
| ---- | --------------------- |
| è§£è€¦   | å‘å¸ƒè€…å’Œè®¢é˜…è€…ç›¸äº’ç‹¬ç«‹ï¼Œä¾¿äºæ¨¡å—é‡ç”¨å’Œæ‰©å±• |
| å¼‚æ­¥å¤„ç† | æé«˜ç³»ç»Ÿååé‡               |
| å¯æ‰©å±•  | æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…æ¨ªå‘æ‰©å±•           |
| çµæ´»   | è®¢é˜…å…³ç³»å¯åŠ¨æ€é…ç½®             |

---

## å››ã€å¸¸è§é—®é¢˜ä¸æŒ‘æˆ˜

å°½ç®¡å‘å¸ƒ-è®¢é˜…æ¨¡å¼éå¸¸å¼ºå¤§ï¼Œä½†åœ¨å·¥ç¨‹å®è·µä¸­ä¼šæš´éœ²å‡ºä¸å°‘é—®é¢˜ï¼š

### 4.1 é—®é¢˜ä¸€ï¼šæ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤

* **åœºæ™¯**ï¼šç³»ç»Ÿå´©æºƒå¯¼è‡´å‘å¸ƒè€…æœªç¡®è®¤ï¼Œæˆ–è€…è®¢é˜…è€…æœªæ­£ç¡®å¤„ç†ã€‚
* **åŸå› **ï¼š

  * æ²¡æœ‰å¯é çš„æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒï¼ˆå¦‚ä½¿ç”¨ Redis åŸç”Ÿ Pub/Subï¼‰
  * ç¼ºä¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * ä½¿ç”¨æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä¸ç¡®è®¤æœºåˆ¶çš„ä¸­é—´ä»¶ï¼ˆå¦‚ Kafkaã€RabbitMQï¼‰
  * å¼•å…¥å¹‚ç­‰å¤„ç†é€»è¾‘ï¼ˆå¦‚äº‹ä»¶IDå»é‡ï¼‰

---

### 4.2 é—®é¢˜äºŒï¼šè®¢é˜…è€…å¤„ç†å¼‚å¸¸å¯¼è‡´ç³»ç»Ÿé˜»å¡æˆ–å¤±è´¥

* **åœºæ™¯**ï¼šæŸä¸ªè®¢é˜…è€…æŠ›å‡ºå¼‚å¸¸ï¼Œå½±å“æ•´ä½“å¤„ç†ã€‚
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * æ¯ä¸ªè®¢é˜…è€…è¿è¡Œåœ¨ç‹¬ç«‹çš„çº¿ç¨‹æˆ–ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ˆå¼‚æ­¥ï¼‰
  * æ·»åŠ å¤±è´¥é‡è¯•æœºåˆ¶ã€æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰
  * ä½¿ç”¨ç†”æ–­å™¨ï¼ˆå¦‚ Hystrixï¼‰éš”ç¦»å¼‚å¸¸ä¼ æ’­

---

### 4.3 é—®é¢˜ä¸‰ï¼šäº‹ä»¶é¡ºåºé”™ä¹±

* **åœºæ™¯**ï¼šAã€B ä¸¤ä¸ªäº‹ä»¶æœ‰ä¾èµ–å…³ç³»ï¼Œå´ä¹±åºæ¶ˆè´¹ã€‚
* **åŸå› **ï¼š

  * åˆ†åŒºæˆ–åˆ†å¸ƒå¼æ¶ˆè´¹å¯¼è‡´äº‹ä»¶é¡ºåºæ··ä¹±
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * ä½¿ç”¨ Kafka çš„ partition key ä¿è¯åŒä¸€ key çš„äº‹ä»¶é¡ºåº
  * åœ¨æ¶ˆè´¹è€…ä¾§å¼•å…¥é€»è¾‘æ’åºç¼“å†²åŒºï¼ˆæŒ‰äº‹ä»¶æ—¶é—´æˆ³/IDé‡æ’ï¼‰

---

### 4.4 é—®é¢˜å››ï¼šéš¾ä»¥è¿½è¸ªå’Œè°ƒè¯•

* **åœºæ™¯**ï¼šæŸä¸ªäº‹ä»¶å¼•å‘äº†è¿é”ååº”ï¼Œä½†éš¾ä»¥è¿˜åŸæµç¨‹ã€‚
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * å¼•å…¥å…¨é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼ˆå¦‚ OpenTelemetryã€Jaegerï¼‰
  * ä¸ºæ¯ä¸ªäº‹ä»¶æºå¸¦ TraceID æˆ– CorrelationID
  * æ—¥å¿—ç»“æ„åŒ–ã€åˆ†å¸ƒå¼æ—¥å¿—èšåˆï¼ˆå¦‚ ELKï¼‰

---

### 4.5 é—®é¢˜äº”ï¼šè®¢é˜…ç®¡ç†æ··ä¹±

* **åœºæ™¯**ï¼šå¤šä¸ªæœåŠ¡æˆ–æ¨¡å—è®¢é˜…åŒä¸€äº‹ä»¶ï¼Œç®¡ç†å›°éš¾ã€‚
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * ä½¿ç”¨ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†è®¢é˜…å…³ç³»ï¼ˆå¦‚ etcdã€Consulï¼‰
  * å¼•å…¥äº‹ä»¶æ³¨å†Œä¸­å¿ƒï¼Œè®°å½•äº‹ä»¶ schema å’Œè®¢é˜…è€…
  * ä½¿ç”¨ schema registryï¼ˆKafka æä¾›ï¼‰åšäº‹ä»¶æ•°æ®æ ¡éªŒ

---

### 4.6 é—®é¢˜å…­ï¼šç³»ç»Ÿé›ªå´©ä¸æ¶ˆæ¯é£æš´

* **åœºæ™¯**ï¼šæŸä¸ªå…³é”®æœåŠ¡å‘å¸ƒäº†å¤§é‡äº‹ä»¶ï¼Œè®¢é˜…è€…å¤„ç†ä¸è¿‡æ¥ã€‚
* **åŸå› **ï¼š

  * ç¼ºä¹é€Ÿç‡é™åˆ¶å’ŒèƒŒå‹æœºåˆ¶
* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * è®¾ç½®å‘å¸ƒé€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰
  * ä¸ºæ¶ˆè´¹è€…æ·»åŠ é˜Ÿåˆ—é™æµã€çº¿ç¨‹æ± ä¿æŠ¤
  * æ¶ˆæ¯ä¸­é—´ä»¶ä½¿ç”¨ backpressureï¼ˆå¦‚ Reactive Streamsï¼‰

---

## äº”ã€æœ€ä½³å®è·µ

| åˆ†ç±»    | å®è·µå»ºè®®                                      |
| ----- | ----------------------------------------- |
| ä¸­é—´ä»¶é€‰æ‹© | æ ¹æ®éœ€æ±‚é€‰æ‹© Kafkaï¼ˆé«˜ååï¼‰ã€RabbitMQï¼ˆå¯é äº¤ä»˜ï¼‰ã€NATSï¼ˆè½»é‡ï¼‰ |
| æ•°æ®ç»“æ„  | äº‹ä»¶ç»“æ„å»ºè®®é‡‡ç”¨ JSON + schema æˆ– protobuf         |
| å¯è§‚æµ‹æ€§  | å¼•å…¥ tracingã€metricsã€logging ä¸‰ä½ä¸€ä½“ç›‘æ§ä½“ç³»       |
| å¼‚å¸¸å¤„ç†  | æ‰€æœ‰è®¢é˜…å¤„ç†é€»è¾‘éœ€åŠ  try-catchï¼Œé˜²æ­¢äº‹ä»¶å¤„ç†ä¸­æ–­             |
| æ•°æ®ä¸€è‡´æ€§ | å¦‚é‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹ï¼Œéœ€å…³æ³¨å¹‚ç­‰å’Œé‡è¯•ç­–ç•¥                     |
| å®‰å…¨æ€§   | å¯¹æ•æ„Ÿäº‹ä»¶åŠ å…¥æƒé™è¿‡æ»¤ã€è„±æ•å¤„ç†                          |

---

## å…­ã€å®é™…æ¡ˆä¾‹è§£æ

### Kafka å®æˆ˜ç¤ºä¾‹

```cpp
// C++ ä½¿ç”¨ librdkafka ä½œä¸ºç”Ÿäº§è€…
rd_kafka_t* producer = rd_kafka_new(...);

rd_kafka_produce(
    topic, partition, RD_KAFKA_MSG_F_COPY,
    payload, payload_len, key, key_len, NULL);
```

**æ³¨æ„äº‹é¡¹**ï¼š

* è®¾ç½® `acks=all` ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±
* æ¶ˆè´¹è€…éœ€æ”¯æŒ offset ç®¡ç†ï¼Œé¿å…é‡å¤å¤„ç†
* åŒæ­¥æˆ–å¼‚æ­¥ callback ç”¨äºç¡®è®¤å‘é€æˆåŠŸæˆ–å¤±è´¥

---

## ä¸ƒã€ç»“è¯­

å‘å¸ƒ-è®¢é˜…æ¨¡å¼æ˜¯ä¸€ç§â€œè§£è€¦ä¼˜é›…ï¼Œä½¿ç”¨è°¨æ…â€çš„è®¾è®¡ç†å¿µã€‚å®ƒå¯ä»¥æå¤§æå‡ç³»ç»Ÿæ‰©å±•æ€§ã€çµæ´»æ€§ï¼Œä½†ä¹Ÿæ½œè—è®¸å¤šå®ç°ç»†èŠ‚ä¸Šçš„é™·é˜±ã€‚åªæœ‰åœ¨ç†è§£å…¶åº•å±‚åŸç†ã€æŒæ¡åˆé€‚çš„ä¸­é—´ä»¶ä¸å¤„ç†æœºåˆ¶åï¼Œæ‰èƒ½çœŸæ­£é©¾é©­è¿™ä¸€æ¶æ„åˆ©å™¨ã€‚

åœ¨æ¶æ„è®¾è®¡ä¸­ï¼Œä¸è¦åªçœ‹åˆ°æ¨¡å¼çš„ç¾ï¼Œæ›´è¦è¯†åˆ«å…¶ä»£ä»·ä¸è¾¹ç•Œâ€”â€”è¿™æ˜¯å·¥ç¨‹å¸ˆçš„æˆç†Ÿæ ‡å¿—ã€‚

---

å¦‚æœä½ å¸Œæœ›æˆ‘æ ¹æ®æŸä¸ªä¸­é—´ä»¶ï¼ˆå¦‚ Kafkaã€Redis Pub/Subã€NATSã€RabbitMQï¼‰è¿›è¡Œæ·±å…¥åˆ†ææˆ–ä»£ç æ¼”ç¤ºï¼Œæˆ‘å¯ä»¥ç»§ç»­è¡¥å……ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

æ˜¯çš„ï¼Œä½ è¯´å¾—å¯¹â€”â€”**å‡¡æ˜¯æ¶‰åŠâ€œTopicâ€æœºåˆ¶çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ç”¨çš„ç¡®å®æ˜¯ Kafka æˆ– Kafka ç±»ä¼¼æœºåˆ¶**ï¼Œä½†è¿˜å¯ä»¥æ ¹æ®è¯­ä¹‰å’Œå®ç°ç»†èŠ‚åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

---

## ä¸€ã€ä¸ºä»€ä¹ˆ Kafka ä¸ Topic ç»‘å®šæœ€ç´§å¯†ï¼Ÿ

Kafka å°†â€œ**å‘å¸ƒ-è®¢é˜… + æ¶ˆæ¯é˜Ÿåˆ—**â€è¿›è¡Œäº†èåˆï¼Œå…¶æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯åŸºäº **Topic + Partition** çš„ï¼š

* **Topic** æ˜¯ Kafka ä¸­çš„**é€»è¾‘æ¶ˆæ¯æµé€šé€šé“**ï¼›
* æ‰€æœ‰ Producer éƒ½å‘æŸä¸ª Topic å†™å…¥æ¶ˆæ¯ï¼›
* æ‰€æœ‰ Consumer é€šè¿‡è®¢é˜… Topic æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼›
* Kafka çš„é«˜ååã€é«˜å¯é ã€å¤šæ¶ˆè´¹è€…ç»„æ¨¡å‹æ­£æ˜¯å»ºç«‹åœ¨ Topic ä¹‹ä¸Šã€‚

Kafka çš„â€œTopicâ€ä¸æ˜¯ä¸€ä¸ªè¯­ä¹‰å±‚é¢çš„æŠ½è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ª**æ ¸å¿ƒçš„ç‰©ç†ç»“æ„ + è·¯ç”±æœºåˆ¶**ã€‚

---

## äºŒã€è¿˜æœ‰å“ªäº›ç³»ç»Ÿä½¿ç”¨ Topic æ¨¡å‹ï¼Ÿ

è™½ç„¶ Kafka æ˜¯â€œTopicâ€æœºåˆ¶çš„ä»£è¡¨ï¼Œä½†å…¶ä»–ä¸­é—´ä»¶æˆ–æ¶æ„ä¸­ä¹Ÿä¼šå¼•å…¥ Topic æˆ–ç±»ä¼¼çš„æ¦‚å¿µï¼š

| ç³»ç»Ÿ/ä¸­é—´ä»¶             | æ˜¯å¦æ”¯æŒ Topic          | æ¨¡å¼                    | ç‰¹ç‚¹                                     |
| ------------------ | ------------------- | --------------------- | -------------------------------------- |
| **Kafka**          | âœ…                   | å‘å¸ƒ-è®¢é˜… + åˆ†åŒºé˜Ÿåˆ—          | é«˜ååã€å¯æŒä¹…åŒ–ã€æ¶ˆè´¹è€…ç»„æ”¯æŒ                        |
| **RabbitMQ**       | âœ…ï¼ˆå¸¦ Topic Exchangeï¼‰ | å‘å¸ƒ-è®¢é˜…ï¼ˆTopic Exchangeï¼‰ | Topic æ˜¯ä¸€ç§ Exchange ç±»å‹ï¼Œç”¨ routing key åŒ¹é… |
| **Redis Pub/Sub**  | âœ…ï¼ˆè¯­ä¹‰ä¸Šï¼‰              | ç®€å•å‘å¸ƒ-è®¢é˜…               | æ— æŒä¹…åŒ–ï¼Œæ¶ˆæ¯ä¸¢å¤±é£é™©é«˜                           |
| **NATS**           | âœ…                   | ä¸»é¢˜åŒ¹é…ï¼ˆå¸¦é€šé…ç¬¦ï¼‰            | è¶…è½»é‡ï¼Œé€‚åˆè¾¹ç¼˜/IoT åœºæ™¯                        |
| **MQTT**           | âœ…                   | IoT ä¸“ç”¨å‘å¸ƒ-è®¢é˜…           | Topic æ”¯æŒå±‚çº§åŒ¹é…ï¼Œé€‚åˆä¼ æ„Ÿå™¨åœºæ™¯                   |
| **Google Pub/Sub** | âœ…                   | äº‘åŸç”Ÿå‘å¸ƒ-è®¢é˜…              | Serverlessï¼Œé«˜å¯ç”¨ï¼Œé«˜æ‰©å±•æ€§                    |

---

## ä¸‰ã€æ€»ç»“

æ˜¯çš„ï¼š

> **å‡¡æ˜¯ä½ çœ‹åˆ°â€œTopicâ€ä½œä¸ºå…³é”®è¯çš„å‘å¸ƒ-è®¢é˜…æ¨¡å‹ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ Kafka æˆ–ç±» Kafka çš„æœºåˆ¶ã€‚**

ä½†ä¹Ÿæœ‰ä¸€äº›å…¶ä»–ä¸­é—´ä»¶ä¸ºäº†ç»Ÿä¸€è¯­ä¹‰ï¼Œä¹Ÿå¼•å…¥äº†ç±»ä¼¼ Topic çš„ç»“æ„ï¼ˆå°½ç®¡åº•å±‚å®ç°æ–¹å¼ä¸åŒï¼‰ï¼š

* Kafka çš„ Topic æ˜¯å¼ºç»“æ„åŒ–çš„ã€æŒä¹…çš„ã€å¯åˆ†åŒºçš„ï¼›
* RabbitMQ çš„ Topic Exchange æ˜¯åŸºäº routing key é€šé…ç¬¦ï¼›
* Redis çš„ Topic æ˜¯ç¬æ—¶çš„ã€æ— æŒä¹…åŒ–çš„ï¼›
* MQTT çš„ Topic æ˜¯å±‚çº§ç»“æ„ï¼ˆå¦‚ `home/room1/temp`ï¼‰ï¼›

---

## å››ã€é€‰å‹å»ºè®®ï¼ˆç®€è¦ï¼‰

| åº”ç”¨åœºæ™¯        | æ¨èä¸­é—´ä»¶                    |
| ----------- | ------------------------ |
| å¤§æ•°æ®æµå¤„ç†ã€æ—¥å¿—ç®¡é“ | Kafka                    |
| å¾®æœåŠ¡è§£è€¦       | Kafka / RabbitMQ         |
| å®æ—¶æ§åˆ¶/è¾¹ç¼˜è®¾å¤‡   | MQTT / NATS              |
| äº‘å¹³å°é›†æˆ       | Google Pub/Sub / AWS SNS |
| å¿«é€ŸåŸå‹å¼€å‘      | Redis Pub/Subï¼ˆä»…é™éå…³é”®åœºæ™¯ï¼‰   |

---

å¦‚æœä½ æ­£åœ¨æ„å»ºæŸç±»ç³»ç»Ÿï¼Œæˆ‘å¯ä»¥å¸®ä½ æ ¹æ®ä½ çš„ä¸šåŠ¡ç‰¹ç‚¹æ¨èæ›´é€‚åˆçš„ Pub/Sub ä¸­é—´ä»¶ã€‚ä½ æœ‰å…·ä½“åœºæ™¯å—ï¼Ÿæˆ‘å¯ä»¥è¿›ä¸€æ­¥ç»™å‡ºå¯¹æ¯”åˆ†æã€‚


ä¸‹é¢é’ˆå¯¹â€œRPC è°ƒç”¨è¿‡å¤šå¯¼è‡´æœåŠ¡é—´è€¦åˆä¸¥é‡â€è¿™ä¸€ç—›ç‚¹ï¼Œæå‡ºå‡ ç§å¸¸è§çš„è§£è€¦æ€è·¯å’Œå®è·µå»ºè®®ï¼Œå¸®åŠ©ä½ åœ¨å·¥ç¨‹ä¸­é€æ­¥æ‹†é™¤â€œç´§è€¦åˆâ€ï¼Œæå‡ç³»ç»Ÿå¯ç»´æŠ¤æ€§å’Œå¯æ¼”è¿›æ€§ã€‚

---

## ä¸€ã€é—®é¢˜ç—›ç‚¹åˆ†æ

1. **èŠå¤© RPCï¼ˆChatty RPCï¼‰**
   æœåŠ¡ A è°ƒç”¨æœåŠ¡ Bã€å†è°ƒç”¨æœåŠ¡ Cã€åˆåè¿‡æ¥è°ƒç”¨ Aâ€¦â€¦é“¾å¼è°ƒç”¨è¿‡é•¿ï¼Œä¸€æ—¦æŸä¸€ç¯èŠ‚å˜æ›´æˆ–æ•…éšœï¼Œæ•´ä¸ªè°ƒç”¨é“¾éƒ½è¦å—å½±å“ã€‚

2. **æ¥å£ç²’åº¦ä¸å½“**
   æ¯ä¸ª RPC æ¥å£éƒ½åšäº†è¿‡å¤šä¸šåŠ¡æ‹¼è£…ï¼Œè°ƒç”¨æ–¹è¢«è¿«ä¸€æ¬¡ä¼ å…¥å¤§é‡å‚æ•°ã€å¾—åˆ°è‡ƒè‚¿çš„æ•°æ®ç»“æ„ã€‚

3. **åŒæ­¥é˜»å¡ä¾èµ–**
   å…¨éƒ¨ç”¨åŒæ­¥ RPCï¼Œä¸€å¤„å“åº”æ…¢å°±ä¼šâ€œè¿é”â€é˜»å¡ï¼Œå½±å“æ•´ä½“ååä¸å¯ç”¨æ€§ã€‚

4. **ç‰ˆæœ¬è€¦åˆ**
   RPC æ¥å£ç‰ˆæœ¬ä¸ç»Ÿä¸€ã€å‡çº§å›°éš¾ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ”¹åŠ¨è”åŠ¨æˆæœ¬é«˜ã€‚

---

## äºŒã€é¢†åŸŸé©±åŠ¨ä¸æœ‰ç•Œä¸Šä¸‹æ–‡

1. **åˆ’åˆ†æœ‰ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰**

   * æŒ‰ç…§ä¸šåŠ¡é¢†åŸŸå°†ç³»ç»Ÿæ‹†åˆ†æˆè‹¥å¹²ç‹¬ç«‹å­åŸŸï¼Œæ¯ä¸ªå­åŸŸå†…ä½¿ç”¨å†…éƒ¨ RPC é€šä¿¡ï¼Œå­åŸŸä¹‹é—´åˆ™é€šè¿‡æ›´æ¾è€¦çš„æ–¹å¼ï¼ˆäº‹ä»¶ã€æ¶ˆæ¯æ€»çº¿ï¼‰äº¤äº’ã€‚
   * ä¸¾ä¾‹ï¼šè®¢å•å­åŸŸã€åº“å­˜å­åŸŸã€ç»“ç®—å­åŸŸåˆ†åˆ«ç‹¬ç«‹ï¼Œé¿å…â€œè®¢å•â†’åº“å­˜â†’ç»“ç®—â†’è®¢å•â€å¾ªç¯ã€‚

2. **é¢†åŸŸäº‹ä»¶é©±åŠ¨ï¼ˆDomain Eventï¼‰**

   * å°†å…³é”®ä¸šåŠ¡åŠ¨ä½œæŠ½è±¡æˆâ€œäº‹ä»¶â€ï¼ˆå¦‚ `OrderCreated`ã€`PaymentSucceeded`ï¼‰ï¼Œé€šè¿‡æ¶ˆæ¯æ€»çº¿ï¼ˆKafka/RabbitMQï¼‰å‘å¸ƒã€‚

   * å…¶ä»–å­åŸŸåªéœ€è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè€Œä¸å¿…çŸ¥é“å‘å¸ƒè€…çš„å…·ä½“ RPC æ¥å£ã€‚

   > **æ•ˆæœ**ï¼šæ¾è€¦åˆã€å¼‚æ­¥åŒ–ã€å¤©ç„¶æ”¯æŒå¤šæ¶ˆè´¹è€…ã€‚

---

## ä¸‰ã€ä»åŒæ­¥ RPC åˆ°å¼‚æ­¥æ¶ˆæ¯

| ä¼ ç»Ÿ RPC    | å¼‚æ­¥æ¶ˆæ¯/äº‹ä»¶é©±åŠ¨  |
| --------- | ---------- |
| åŒæ­¥è°ƒç”¨ã€é˜»å¡ç­‰å¾… | å‘å¸ƒ-è®¢é˜…ã€å¼‚æ­¥å¤„ç† |
| ä¸¥é‡ä¾èµ–å¯ç”¨æ€§   | è‡ªç„¶å‰Šå³°å¡«è°·     |
| æœåŠ¡å¯ç”¨å³ç«‹å³å“åº” | ä½¿ç”¨é˜Ÿåˆ—åšæµé‡ç¼“å†²  |

1. **å¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶**

   * Kafkaã€RabbitMQã€NATS ç­‰ï¼Œç”¨äºæ‰¿è½½é¢†åŸŸäº‹ä»¶æˆ–å‘½ä»¤æ¶ˆæ¯ã€‚
   * ç”Ÿäº§è€…ä»…è´Ÿè´£â€œfire-and-forgetâ€ï¼Œæ¶ˆè´¹è€…è‡ªè¡Œå»æ‹‰ã€å»é‡ã€é‡è¯•ã€‚

2. **æ¥å£æ‹†åˆ†ä¸èŒè´£å•ä¸€**

   * åŸå…ˆä¸€ä¸ªâ€œä¸‹å•â€RPC â†’ åŒæ—¶å®Œæˆåº“å­˜ã€ä¼˜æƒ ã€è´¦å•ï¼Œæ‹†æˆï¼š

     1. RPC ä»…è´Ÿè´£â€œå†™å…¥è®¢å•åº“â€
     2. å‘å¸ƒ `OrderCreated` äº‹ä»¶
     3. åº“å­˜æœåŠ¡å¼‚æ­¥æ¶ˆè´¹ï¼Œæ‰£å‡åº“å­˜å¹¶å‘å¸ƒ `InventoryDeducted`
     4. ç»“ç®—æœåŠ¡å¼‚æ­¥æ¶ˆè´¹â€¦â€¦

---

## å››ã€èšåˆå±‚ï¼ˆAPI Gateway / BFFï¼‰

1. **API Gateway**

   * ä¸ºå®¢æˆ·ç«¯æä¾›ä¸€å¥—â€œé—¨é¢â€æ¥å£ï¼Œå†…éƒ¨å¯ä»¥å¹¶è¡Œã€ä¸²è¡Œåœ°è°ƒç”¨å¤šæœåŠ¡ RPC æˆ–æ¶ˆæ¯ã€‚
   * å®¢æˆ·ç«¯åªéœ€å…³å¿ƒ Gatewayï¼Œä¸ç”¨ç›´æ¥è°ƒç”¨å„ä¸ªåç«¯æœåŠ¡ã€‚

2. **BFFï¼ˆBackend For Frontendï¼‰**

   * é’ˆå¯¹ä¸åŒå®¢æˆ·ç«¯ï¼ˆWebã€Appã€å°ç¨‹åºï¼‰æä¾›å®šåˆ¶åŒ–èšåˆå±‚ï¼Œè¿›ä¸€æ­¥å‡å°‘å†—ä½™ RPC è°ƒç”¨ã€‚

> **å¥½å¤„**ï¼š
>
> * å®¢æˆ·ç«¯ä¸åç«¯æœåŠ¡è§£è€¦ï¼Œåªå¯¹å¤–æš´éœ²å°‘é‡èšåˆæ¥å£ã€‚
> * åç«¯å¯ä»¥çµæ´»åœ°è°ƒæ•´æœåŠ¡æ‹†åˆ†ã€ç‰ˆæœ¬å‡çº§ï¼Œä¸å½±å“å‰ç«¯ã€‚

---

## äº”ã€æ¥å£è®¾è®¡ä¸ç‰ˆæœ¬ç®¡ç†

1. **å¥‘çº¦ä¼˜å…ˆï¼ˆContract-Firstï¼‰**

   * ä½¿ç”¨ OpenAPI/Protobuf å®šä¹‰æ¥å£å¥‘çº¦ï¼Œè‡ªåŠ¨ç”Ÿæˆ Client Stubã€‚
   * å¼ºåˆ¶å¥‘çº¦è¯„å®¡ï¼Œé¿å…è°ƒç”¨æ–¹ç›´æ¥æ”¹åŠ¨æœåŠ¡ç«¯å†…éƒ¨é€»è¾‘ã€‚

2. **æ¥å£ç‰ˆæœ¬åŒ–**

   * å¯¹å¤–æ¥å£ä¸€æ—¦å‘å¸ƒä¸å¯éšæ„å˜æ›´ï¼Œéœ€æ–°å¢ `/v2/xxx`ã€‚
   * é€šè¿‡ API Gateway æˆ–æœåŠ¡ä»£ç†åšç°åº¦è·¯ç”±ï¼Œå¹³æ»‘åˆ‡æ¢ã€‚

---

## å…­ã€Saga æ¨¡å¼ä¸åˆ†å¸ƒå¼äº‹åŠ¡

1. **Saga ç¼–æ’ï¼ˆOrchestrationï¼‰**

   * ç”¨ç»Ÿä¸€çš„â€œäº‹åŠ¡åè°ƒè€…â€æ¥ä¸²è”å„æœåŠ¡æ“ä½œï¼Œæ›¿ä»£å¤šä¸ªåŒæ­¥ RPCã€‚
   * å‡ºé”™æ—¶ï¼Œåè°ƒè€…æŒ‰é€†åºè§¦å‘è¡¥å¿æ“ä½œã€‚

2. **Saga ç¼–æ’ï¼ˆChoreographyï¼‰**

   * å„æœåŠ¡é€šè¿‡å‘å¸ƒ/è®¢é˜…é¢†åŸŸäº‹ä»¶å®Œæˆè”åŠ¨ï¼Œæ— ä¸­å¿ƒåè°ƒè€…ï¼Œæ›´æ¾è€¦åˆã€‚

---

## ä¸ƒã€æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰

1. **æµé‡ç®¡ç†**

   * åˆ©ç”¨ Istioã€Linkerd åšæ™ºèƒ½è·¯ç”±ã€ç†”æ–­ã€é™æµï¼Œå‡å°‘æœåŠ¡é—´ç›´æ¥ä¾èµ–å¸¦æ¥çš„é£é™©ã€‚

2. **å¯è§‚å¯Ÿæ€§**

   * è‡ªåŠ¨åŒ–æ¥å…¥ç›‘æ§ã€Tracingï¼Œå¿«é€Ÿå®šä½å“ªæ¡ RPC è°ƒç”¨é“¾è¿‡é•¿ã€å¤±è´¥ç‡é«˜ã€‚

---

## å…«ã€å°ç»“ä¸è½åœ°å»ºè®®

1. **å…ˆåšæœ‰ç•Œä¸Šä¸‹æ–‡æ¢³ç†**ï¼šç”»å‡ºè°ƒç”¨ä¾èµ–å›¾ï¼Œæ˜ç¡®å„å­åŸŸè¾¹ç•Œã€‚
2. **ä¼˜å…ˆå¼•å…¥å¼‚æ­¥äº‹ä»¶**ï¼šå°†æœ€â€œChattyâ€çš„ RPC è·¯å¾„æ”¹ä¸ºäº‹ä»¶é©±åŠ¨ã€‚
3. **æ­å»ºèšåˆå±‚**ï¼šéšè—å¤šæ¬¡ RPCï¼Œç»™å®¢æˆ·ç«¯ä¸€ç«™å¼æ¥å£ã€‚
4. **å¥‘çº¦ä¸ç‰ˆæœ¬ç®¡ç†**ï¼šç”¨ API å®šä¹‰å·¥å…·ä¸¥æ ¼ç®¡æ§æ¥å£å˜æ›´ã€‚
5. **æ¸è¿›å¼æ¼”è¿›**ï¼šå…ˆåœ¨éæ ¸å¿ƒé“¾è·¯è¯•ç‚¹å¼‚æ­¥/äº‹ä»¶ï¼Œå†é€æ­¥æ¨å¹¿åˆ°å…¨å±€ã€‚

é€šè¿‡ä¸Šè¿°åˆ†å±‚ã€å¼‚æ­¥åŒ–ã€å¥‘çº¦æ²»ç†ç­‰æ‰‹æ®µï¼Œèƒ½æœ‰æ•ˆç¼“è§£â€œRPC è°ƒç”¨è¿‡å¤šâ€å¸¦æ¥çš„è€¦åˆç—›ç‚¹ï¼Œè®©ç³»ç»Ÿæ›´æ˜“æ¼”è¿›ã€æ›´å¥å£®ã€‚


ä¸‹é¢é’ˆå¯¹â€œä¸šåŠ¡é€»è¾‘ç›´æ¥å¤§é‡è€¦åˆ RPC IDL ç»“æ„ä½“â€çš„ç—›ç‚¹ï¼Œç»™å‡ºä¸€ä¸ªé€šç”¨çš„åˆ†å±‚æ¶æ„æ€è·¯ï¼Œæ¼”ç¤ºå¦‚ä½•é€šè¿‡\*\*â€œç«¯å£â€‘é€‚é…å™¨ï¼ˆPorts & Adaptersï¼‰/å…­è¾¹å½¢æ¶æ„ï¼ˆHexagonalï¼‰â€\*\*æ¥è§£è€¦ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨æ¥å£æ³¨å…¥å’Œæ¨¡æ‹Ÿå¯¹è±¡å®ç°ç®€å•çš„å•å…ƒæµ‹è¯•ã€‚

---

## ä¸€ã€å…¸å‹é—®é¢˜åœºæ™¯

1. **IDL ç»“æ„ä½“æ³›æ»¥**

   ```proto
   message DeviceStatus { â€¦ }
   message SensorReading { â€¦ }
   message ControlCommand { â€¦ }
   // ä¸šåŠ¡ä»£ç é‡Œç›´æ¥ï¼šDeviceStatus status; process(status); â€¦
   ```
2. **ä¸šåŠ¡å±‚ç›´æ¥ä¾èµ– RPC åº“**

   ```cpp
   auto resp = rpc_client->GetStatus(request);
   // è§£æ resp.DeviceStatusã€resp.ControlCommandï¼Œæ‰§è¡Œä¸šåŠ¡
   ```
3. **éš¾ä»¥å•æµ‹**

   * ä¸šåŠ¡é€»è¾‘é‡Œç›´æ¥ new/è°ƒç”¨ rpc\_client
   * æ¨¡æ‹Ÿ RPC è¡Œä¸ºä¸ä¾¿

---

## äºŒã€åˆ†å±‚æ¶æ„ï¼ˆPorts & Adaptersï¼‰

```text
+----------------------+
|      Presentation    |  â†â†’  UI / CLI / WebAPI
+----------------------+
         â”‚
         â–¼
+----------------------+
|   Application Core   |  â†  Domain Services, Use Cases
+----------------------+
         â”‚    â–²
   Port  â”‚    â”‚   Port
 (interface)   â”‚
         â–¼    â”‚
+----------------------+    Adapter       +----------------------+
| Infrastructure / RPC |  â†â€”â€”â€”â€”â€”â€”â€”â†’ â”€â€”â€”â€”â€”â€”â†’ |   RPC Stub / Mock    |
|  (gRPC client, IDL)  |                |   (for unit test)     |
+----------------------+                +----------------------+
```

1. **Portsï¼ˆæ¥å£å±‚ï¼‰**

   * å®šä¹‰ä¸€ç»„çº¯è™šæ¥å£ï¼ˆC++ï¼‰æˆ–æŠ½è±¡å¥‘çº¦ï¼ˆJava/C#ï¼‰ï¼Œæ¯”å¦‚ï¼š

     ```cpp
     struct IDeviceRpc {
       virtual SensorReading getSensorReading(DeviceId) = 0;
       virtual void sendControl(const ControlCommand&) = 0;
       virtual ~IDeviceRpc() = default;
     };
     ```
   * **ä¸å…·ä½“ IDL ç±»å‹è§£è€¦**ï¼šä¸šåŠ¡å±‚åªä¾èµ–è¿™äº›æ¥å£ï¼Œä¸ä¾èµ– gRPC æˆ– Protobufã€‚

2. **Application Coreï¼ˆä¸šåŠ¡å±‚ï¼‰**

   * åªè°ƒç”¨ `IDeviceRpc` æ¥å£ï¼Œæ‰§è¡Œä¸šåŠ¡æµç¨‹ã€‚
   * ä½¿ç”¨**é¢†åŸŸæ¨¡å‹ï¼ˆDomain Modelï¼‰**æˆ–**DTO**ï¼šå®šä¹‰è‡ªå·±çš„ `SensorData`ã€`Command`ï¼Œä¸ IDL ç±»å‹æ˜ å°„ã€‚

     ```cpp
     struct SensorData { /* domain fields */ };
     struct Command    { /* domain fields */ };
     ```
   * ä¸šåŠ¡é€»è¾‘ç¤ºä¾‹ï¼š

     ```cpp
     class DeviceManager {
       IDeviceRpc& rpc_;
     public:
       DeviceManager(IDeviceRpc& rpc): rpc_(rpc) {}

       void monitorAndControl(DeviceId id) {
         auto reading = rpc_.getSensorReading(id);
         SensorData data = Mapper::toDomain(reading);
         if (shouldAlert(data)) {
           Command cmd = decideCommand(data);
           rpc_.sendControl(Mapper::toRpc(cmd));
         }
       }
     };
     ```

3. **Adaptersï¼ˆé€‚é…å±‚ï¼‰**

   * **RPC Adapter**ï¼šå°† `IDeviceRpc` æ¥å£å®ç°ä¸ºçœŸæ­£è°ƒç”¨ gRPC Stub çš„ç±»ã€‚

     ```cpp
     class GrpcDeviceRpc : public IDeviceRpc {
       std::unique_ptr<Grpc::Stub> stub_;
     public:
       SensorReading getSensorReading(DeviceId id) override {
         auto req = toRpcRequest(id);
         auto resp = stub_->GetSensorStatus(req);
         return resp.reading();
       }
       // â€¦ sendControl åŒç† â€¦
     };
     ```
   * **Mapper/Translator**ï¼šæä¾› `toDomain()`ã€`toRpc()` å‡½æ•°ï¼Œé›†ä¸­åš Protobuf â†” Domain çš„è½¬æ¢ã€‚

4. **Infrastructureï¼ˆå¤–éƒ¨ä¾èµ–ï¼‰**

   * çœŸæ­£çš„ gRPC å®¢æˆ·ç«¯åº“ã€ç½‘ç»œã€åºåˆ—åŒ–ã€æ—¥å¿—ç­‰ï¼Œåªåœ¨é€‚é…å±‚ä½¿ç”¨ã€‚

---

## ä¸‰ã€å¦‚ä½•åšå•å…ƒæµ‹è¯•

1. **Mock/Stub å®ç° `IDeviceRpc`**

   ```cpp
   class MockDeviceRpc : public IDeviceRpc {
     SensorReading reading_;
     ControlCommand lastSent_;
   public:
     void setReading(const SensorReading& r) { reading_ = r; }
     SensorReading getSensorReading(DeviceId) override { return reading_; }
     void sendControl(const ControlCommand& c) override { lastSent_ = c; }
     const ControlCommand& lastCommand() const { return lastSent_; }
   };
   ```

2. **æ³¨å…¥ Mock**

   ```cpp
   TEST(DeviceManagerTest, AlertOnHighTemp) {
     MockDeviceRpc mockRpc;
     // æ„é€ ä¸€ä¸ªè¶…æ¸© SensorReading
     SensorReading high = makeHighTempReading();
     mockRpc.setReading(high);

     DeviceManager mgr(mockRpc);
     mgr.monitorAndControl(42);

     // éªŒè¯ rpc_.sendControl è¢«è°ƒç”¨ï¼Œä¸”å‚æ•°æ­£ç¡®
     EXPECT_EQ(mockRpc.lastCommand().type(), ControlCommand::SHUTDOWN);
   }
   ```

3. **ä¸éœ€è¦å¯åŠ¨ gRPC æœåŠ¡**

   * ä»…æµ‹è¯•ä¸šåŠ¡ç”¨ä¾‹ï¼Œä¸ä¼šæœ‰ç½‘ç»œä¾èµ–ï¼Œé€Ÿåº¦å¿«ï¼Œç¨³å®šæ€§é«˜ã€‚

---

## å››ã€å…³é”®è¦ç‚¹æ€»ç»“

* **åˆ†å±‚æ¸…æ™°**ï¼š

  * **Domain/Application** â†” **Portsï¼ˆæ¥å£ï¼‰** â†” **Adaptersï¼ˆå®ç°ï¼‰**
  * ä¸šåŠ¡ä»£ç åªä¾èµ– Portsã€‚

* **è‡ªå®šä¹‰ Domain DTO**ï¼š

  * ä¸è¦åœ¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é‡Œæš´éœ² IDL/Protobuf ç±»å‹ï¼Œä½¿ç”¨è½»é‡çš„é¢†åŸŸæ¨¡å‹æˆ– DTOã€‚

* **ç»Ÿä¸€ Mapper**ï¼š

  * æ‰€æœ‰åºåˆ—åŒ–/ååºåˆ—åŒ–éƒ½æ”¾åœ¨ä¸€ä¸ªæ¨¡å—ï¼ˆæˆ–æ–‡ä»¶ï¼‰ï¼Œé›†ä¸­ç»´æŠ¤ã€‚

* **ä¾èµ–æ³¨å…¥**ï¼š

  * é€šè¿‡æ„é€ å‡½æ•°æˆ– DI å®¹å™¨æ³¨å…¥ `IDeviceRpc`ï¼Œæ–¹ä¾¿æ›¿æ¢çœŸå®å®ç°ï¼Mockã€‚

* **æ¥å£ä¼˜å…ˆ**ï¼š

  * å…ˆå®šä¹‰ `IDeviceRpc` ç­‰æ¥å£ï¼Œå†å®ç°é€‚é…å™¨ã€‚è¿™æ ·å¯ä»¥å…ˆä¸ºæµ‹è¯•ç¼–å†™ Mockï¼Œå†é€æ­¥å®ŒæˆçœŸæ­£çš„ç½‘ç»œé€»è¾‘ã€‚

é€šè¿‡ä»¥ä¸Šæ¶æ„ï¼Œä¸ä»…**æ¶ˆé™¤äº†ä¸šåŠ¡é€»è¾‘å¯¹ Protobuf IDL çš„ç›´æ¥ä¾èµ–**ï¼Œè¿˜è®©**å•å…ƒæµ‹è¯•å˜å¾—ç®€å•ã€å¿«é€Ÿã€å¯æ§**ã€‚ä½ å¯ä»¥æŒ‰ç…§æ­¤æ€è·¯ï¼Œåœ¨é¡¹ç›®ä¸­åˆ†æ­¥å¼•å…¥ Ports & Adapters æ¨¡å¼ï¼Œé€æ­¥æ‹†é™¤â€œRPC ç»‘æ­»ä¸šåŠ¡â€å¸¦æ¥çš„è€¦åˆã€‚


åœ¨ C++ ä¸­ï¼Œå¦‚æœä½ å‘ç°è‡ªå·±åœ¨å…¨å±€å˜é‡æˆ–è€…å¤§é‡ `switch`/`if-else` é‡Œå†™æ­»äº†å„ä¸ªçŠ¶æ€ä¸‹çš„è½¬æ¢é€»è¾‘ï¼Œç¡®å®å¾ˆå®¹æ˜“é™·å…¥ã€Œç¡¬ç¼–ç åœ°ç‹±ã€ï¼Œç»´æŠ¤æˆæœ¬é«˜ã€æ‰©å±•å›°éš¾ã€‚ä¸‹é¢å…ˆä»‹ç»ç»å…¸çš„ **çŠ¶æ€æ¨¡å¼ï¼ˆState Patternï¼‰**ï¼Œå†ç»™å‡ºå‡ ç§æ›¿ä»£æˆ–è¡¥å……çš„æ–¹æ³•ï¼Œå¸®åŠ©ä½ æ ¹æ®åœºæ™¯æƒè¡¡å–èˆã€‚

---

## ä¸€ã€çŠ¶æ€æ¨¡å¼ï¼ˆState Patternï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†æ¯ä¸ªçŠ¶æ€å°è£…ä¸ºä¸€ä¸ªç±»ï¼Œå¹¶æŠŠçŠ¶æ€åˆ‡æ¢çš„é€»è¾‘ï¼ˆä»¥åŠåœ¨è¯¥çŠ¶æ€ä¸‹çš„è¡Œä¸ºï¼‰éƒ½æ”¾åˆ°è¿™ä¸ªç±»é‡Œã€‚ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰åªæŒæœ‰ä¸€ä¸ªæŒ‡å‘å½“å‰çŠ¶æ€çš„æŒ‡é’ˆï¼Œæ‰€æœ‰çš„çŠ¶æ€è½¬æ¢éƒ½ç”±çŠ¶æ€å¯¹è±¡è‡ªå·±å†³å®šæˆ–è§¦å‘ã€‚

### UML ç®€å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     1     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ State        â”‚ (æŠ½è±¡åŸºç±»)
â”‚ - state   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ + Request â”‚           â–²    â–²     â–²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚     â”‚
                        â”‚    â”‚     â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚State A â”‚â”‚State B â”‚â”‚State C â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹

```cpp
// state.hpp
class Context;  // å‰å‘å£°æ˜

// æŠ½è±¡çŠ¶æ€æ¥å£
class State {
public:
    virtual ~State() = default;
    // æ ¹æ®äº‹ä»¶ï¼Œå†³å®šæ˜¯å¦åˆ‡æ¢çŠ¶æ€
    virtual void handle(Context& ctx, int event) = 0;
};

// context.hpp
#include "state.hpp"
#include <memory>
class Context {
public:
    Context(std::unique_ptr<State> s) : state_(std::move(s)) {}
    void setState(std::unique_ptr<State> s) { state_ = std::move(s); }
    void request(int event) {
        state_->handle(*this, event);
    }
private:
    std::unique_ptr<State> state_;
};

// concrete_states.hpp
#include "context.hpp"
#include <iostream>

class StateA : public State {
public:
    void handle(Context& ctx, int event) override {
        std::cout << "StateA handling event " << event << "\n";
        if (event == 1) {
            ctx.setState(std::make_unique<StateB>());
        }
    }
};

class StateB : public State {
public:
    void handle(Context& ctx, int event) override {
        std::cout << "StateB handling event " << event << "\n";
        if (event == 2) {
            ctx.setState(std::make_unique<StateC>());
        }
    }
};

class StateC : public State {
public:
    void handle(Context& ctx, int event) override {
        std::cout << "StateC handling event " << event << "\n";
        if (event == 0) {
            ctx.setState(std::make_unique<StateA>());
        }
    }
};
```

**ä¼˜ç‚¹**

* æ¯ä¸ªçŠ¶æ€çš„é€»è¾‘é«˜åº¦å†…èšã€æ˜“äºé˜…è¯»å’Œæµ‹è¯•
* æ–°å¢ï¼åˆ å‡çŠ¶æ€æ—¶ï¼Œåªéœ€å¢åŠ ï¼ç§»é™¤å¯¹åº”ç±»ï¼Œä¸ç”¨æ”¹ä¸­å¿ƒä»£ç 
* ç¬¦åˆå¼€é—­åŸåˆ™ï¼ˆOCPï¼‰

**ç¼ºç‚¹**

* å½“çŠ¶æ€æ•°é‡çˆ†ç‚¸æ—¶ï¼Œä¼šå¸¦æ¥å¤§é‡ç±»å’Œæ–‡ä»¶
* çŠ¶æ€è½¬æ¢é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªç±»é‡Œï¼Œä¸æ˜“ä¸€çœ¼çœ‹å‡ºå…¨å±€æµç¨‹

---

## äºŒã€è¡¨é©±åŠ¨ï¼ˆTable-Drivenï¼‰çŠ¶æ€æœº

æŠŠçŠ¶æ€å’Œäº‹ä»¶ã€åŠ¨ä½œéƒ½æŠ½è±¡æˆè¡¨æ ¼ï¼ˆäºŒç»´æ•°ç»„æˆ–æ˜ å°„ï¼‰ï¼Œç»Ÿä¸€ç®¡ç†ï¼š

```cpp
enum class State { A, B, C };
enum class Event { ev1, ev2, ev0 };

// åŠ¨ä½œå‡½æ•°ç­¾å
using Action = std::function<void()>;

// çŠ¶æ€è½¬æ¢è¡¨
struct Transition {
    State       next_state;
    Action      action;       // å¯é€‰ï¼šåœ¨è½¬æ¢æ—¶æ‰§è¡Œ
};
std::map<std::pair<State,Event>, Transition> table = {
    {{State::A, Event::ev1}, {State::B, []{ std::cout<<"A->B\n"; }}},
    {{State::B, Event::ev2}, {State::C, []{ std::cout<<"B->C\n"; }}},
    {{State::C, Event::ev0}, {State::A, []{ std::cout<<"C->A\n"; }}},
};

class FSM {
public:
    FSM(State init) : s(init) {}
    void onEvent(Event e) {
        auto it = table.find({s,e});
        if (it != table.end()) {
            it->second.action();
            s = it->second.next_state;
        }
    }
private:
    State s;
};
```

**ä¼˜ç‚¹**

* æ‰€æœ‰è½¬æ¢é›†ä¸­ä¸€å¤„ï¼Œæ˜“äºå¯è§†åŒ–ã€ç»´æŠ¤
* æ”¯æŒæ•°æ®é©±åŠ¨ï¼åŠ¨æ€åŠ è½½ï¼ˆå¯ä» JSONï¼é…ç½®æ–‡ä»¶è¯»è¡¨ï¼‰
* å½“çŠ¶æ€å¤šã€è½¬æ¢å¤šæ—¶æ›´æ¸…æ™°

**ç¼ºç‚¹**

* é€»è¾‘ä¸ä»£ç åˆ†ç¦»ï¼Œè°ƒè¯•å¯èƒ½æ²¡é‚£ä¹ˆç›´è§‚
* åŠ¨ä½œå‡½æ•°éœ€é¢å¤–è®¾è®¡

---

## ä¸‰ã€å…¶å®ƒå¸¸è§æ–¹æ³•

1. **å‡½æ•°æŒ‡é’ˆï¼å›è°ƒæ³¨å†Œ**

   * ç”¨ `std::function` æˆ–å‡½æ•°æŒ‡é’ˆè¡¨ï¼Œç±»ä¼¼è¡¨é©±åŠ¨ï¼Œä½†æ›´çµæ´»
   * é€‚åˆç®€å•çš„çŠ¶æ€ï¼‹äº‹ä»¶ï¼Œé¿å…å†™å¤§é‡ç±»

2. **`std::variant` + `std::visit`**

   * å°†çŠ¶æ€ç”¨ `std::variant<StateA,StateB,â€¦>` è¡¨ç¤ºï¼Œè¡Œä¸ºç»Ÿä¸€è°ƒåº¦
   * ç¼–è¯‘æœŸå®‰å…¨ã€æ— æŒ‡é’ˆå¼€é”€

3. **æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆCompileâ€time FSMï¼‰**

   * ä¾‹å¦‚ [Boost.MPL](https://www.boost.org/doc/libs/release/libs/mpl/doc/index.html) æˆ–è‡ªå·±å®ç°
   * é€‚åˆçŠ¶æ€ï¼è½¬æ¢å®Œå…¨åœ¨ç¼–è¯‘æœŸå·²çŸ¥çš„åœºæ™¯ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

4. **ç°æˆ FSM åº“**

   * [Boost.Statechart](https://www.boost.org/doc/libs/release/libs/statechart/)
   * [Boost.MSM (Meta State Machine)](https://www.boost.org/doc/libs/release/libs/msm/doc/HTML/index.html)
   * [Qt State Machine Framework](https://doc.qt.io/qt-5/statemachine-api.html)
   * ä¼˜ç‚¹ï¼šåŠŸèƒ½ä¸°å¯Œï¼ˆå±‚æ¬¡çŠ¶æ€ã€å¹¶è¡ŒçŠ¶æ€ã€å†å²çŠ¶æ€ç­‰ï¼‰

5. **è„šæœ¬ï¼DSL é©±åŠ¨**

   * æŠŠçŠ¶æ€æœºå®šä¹‰å†™åœ¨ Luaï¼Python è„šæœ¬æˆ–è‡ªå®šä¹‰ DSL ä¸­ï¼Œè¿è¡Œæ—¶åŠ¨æ€è§£æ
   * è®©ä¸šåŠ¡äººå‘˜å¯é…ç½®çŠ¶æ€é€»è¾‘ï¼ŒC++ åªåšå¼•æ“

6. **Behavior Tree / Workflow Engine**

   * å½“çŠ¶æ€æœºé€»è¾‘è¿‡äºå¤æ‚æ—¶ï¼Œå¯è€ƒè™‘ç”¨è¡Œä¸ºæ ‘ï¼ˆBehavior Treeï¼‰æˆ–å·¥ä½œæµå¼•æ“ï¼Œç»“æ„æ›´çµæ´»ã€å…·æœ‰æ›´å¤šå¤ç”¨ç»„åˆèƒ½åŠ›

---

## ä¸‰ã€å¦‚ä½•é€‰æ‹©ï¼Ÿ

| æ–¹æ¡ˆ                   | é€‚ç”¨åœºæ™¯                    | ä¼˜åŠ£          |
| -------------------- | ----------------------- | ----------- |
| çŠ¶æ€æ¨¡å¼ï¼ˆStateï¼‰          | ä¸­ç­‰å¤æ‚ã€çŠ¶æ€å’Œè¡Œä¸ºä¸€ä¸€å¯¹åº”ï¼Œéœ€è¦é¢å‘å¯¹è±¡å°è£… | æ¸…æ™°ã€æ˜“æ‰©å±•ï¼›ç±»å¤š   |
| è¡¨é©±åŠ¨                  | çŠ¶æ€/äº‹ä»¶å¾ˆå¤šï¼Œé€»è¾‘é›†ä¸­ï¼Œéœ€åŠ¨æ€é…ç½®      | æ˜“ç»´æŠ¤ï¼›è°ƒè¯•æ¬ ç›´è§‚   |
| å‡½æ•°æŒ‡é’ˆï¼å›è°ƒ              | çŠ¶æ€ç®€å•ã€äº‹ä»¶å°‘ï¼Œé€»è¾‘è½»é‡           | ç®€æ´ï¼›å¯è¯»æ€§ä¸­ç­‰    |
| `std::variant`+visit | çŠ¶æ€æ•°å°‘ã€ç¼–è¯‘æœŸå®‰å…¨ã€è¿½æ±‚é›¶å¼€é”€        | æ— è™šå‡½æ•°å¼€é”€ï¼›è¯­æ³•å•°å—¦ |
| å…ƒç¼–ç¨‹ï¼Boost.MSM        | å®Œå…¨é™æ€ä¿¡æ¯ã€è¿½æ±‚æ€§èƒ½             | é›¶å¼€é”€ï¼›å­¦ä¹ æ›²çº¿é™¡å³­  |
| è„šæœ¬ï¼DSL               | ä¸šåŠ¡äººå‘˜å¯é…ï¼Œéœ€çƒ­æ›´æ–°ã€è·¨è¯­è¨€         | çµæ´»ï¼›å¢åŠ è¿è¡Œæ—¶ä¾èµ–  |

---

### å°ç»“

* **æ¶ˆé™¤ç¡¬ç¼–ç **ï¼šå°†â€œçŠ¶æ€ï¼‹è½¬æ¢â€ä»æ•£è½åœ¨å„å¤„çš„ `if/switch` ä¸­æç‚¼å‡ºæ¥ï¼Œå°è£…æˆ–è¡¨é©±åŠ¨ã€‚
* **æ‰©å±•æ€§ vs. ç®€æ´æ€§**ï¼šçŠ¶æ€æ¨¡å¼é¢å‘å¯¹è±¡ã€æ˜“åœ¨å¤§é¡¹ç›®ä¸­ç®¡ç†ï¼›è¡¨é©±åŠ¨æ›´é€‚åˆé…ç½®åŒ–å’Œå¯è§†åŒ–ï¼›å‡½æ•°æŒ‡é’ˆã€`std::variant` åˆ™é€‚åˆè½»é‡åœºæ™¯ã€‚
* **å¯ç»´æŠ¤æ€§**ï¼šå§‹ç»ˆæŠŠâ€œä¸šåŠ¡çŠ¶æ€â€â€œäº‹ä»¶â€â€œåŠ¨ä½œâ€åˆ†ç¦»ï¼Œè®©è®¾è®¡æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´æ˜“æµ‹è¯•ã€è°ƒè¯•ã€‚

æ ¹æ®ä½ çš„é¡¹ç›®è§„æ¨¡ã€å›¢é˜ŸæŠ€èƒ½å’Œæœªæ¥çš„æ‰©å±•éœ€æ±‚ï¼Œé€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆå³å¯ã€‚å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼

é™¤äº†åœ¨â€œçŠ¶æ€â€æˆ–â€œäº‹ä»¶â€ç»´åº¦ä¹‹å¤–å†åŠ ä¸€ä¸ªâ€œç‰ˆæœ¬â€ç»´åº¦ï¼Œä½ å¯ä»¥ç”¨å¤šç§æ–¹å¼æ¥ä¼˜é›…åœ°æ”¯æŒè‡³å°‘ä¸¤ä¸ªç‰ˆæœ¬çš„å…¼å®¹å’Œä¸åŒå¤„ç†é€»è¾‘ã€‚ä¸‹é¢ç»™å‡ºå‡ ç§å¸¸è§æ–¹æ¡ˆâ€”â€”ä½ å¯ä»¥æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦å’Œå›¢é˜Ÿä¹ æƒ¯é€‰ç”¨æˆ–ç»„åˆï¼š

---

## 1. å¤šè¡¨ + é…ç½®åŒ–é©±åŠ¨

åœ¨è¡¨é©±åŠ¨çš„åŸºç¡€ä¸Šï¼ŒæŠŠç‰ˆæœ¬ä½œä¸ºè¡¨çš„ä¸€çº§ç»´åº¦ï¼Œç»´æŠ¤ä¸€ç»„â€œç‰ˆæœ¬â†’è½¬æ¢è¡¨â€æ˜ å°„ï¼š

```cpp
using Transition = struct {
    State       next;
    std::function<void()> action;
};

// æ¯ä¸ªç‰ˆæœ¬å¯¹åº”ä¸€å¼ è½¬æ¢è¡¨
std::map<std::pair<State,Event>, Transition> table_v1 = { /* â€¦ */ };
std::map<std::pair<State,Event>, Transition> table_v2 = { /* â€¦ */ };

class FSM {
public:
    FSM(Version ver)
      : ver_(ver),
        table_(ver == Version::V1 ? &table_v1 : &table_v2)
    {}

    void onEvent(State& s, Event e) {
        auto it = table_->find({s,e});
        if (it != table_->end()) {
            it->second.action();
            s = it->second.next;
        }
    }
private:
    Version ver_;
    const std::map<std::pair<State,Event>, Transition>* table_;
};
```

* **ä¼˜ç‚¹**ï¼š

  * ä¸åŒç‰ˆæœ¬é€»è¾‘å®Œå…¨éš”ç¦»ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿå¯æŒ‰ `v1.json`ã€`v2.json` å­˜æ”¾ï¼›
  * å¯åŠ¨æ—¶è¯»å…¥å¯¹åº”ç‰ˆæœ¬çš„è¡¨ï¼Œæ— éœ€æ”¹ä»£ç å°±èƒ½åˆ‡æ¢ï¼›
* **ç¼ºç‚¹**ï¼šå½“ç‰ˆæœ¬é€»è¾‘å·®å¼‚è¾ƒå¤§ï¼Œè¡¨ä¼šå˜å¾—åºå¤§ã€‚

---

## 2. ç­–ç•¥ï¼ˆStrategyï¼‰+ çŠ¶æ€æœº

ç”¨ç­–ç•¥æ¨¡å¼æŠŠâ€œç‰ˆæœ¬â€æŠ½è±¡æˆä¸€é¢—ç­–ç•¥æ ‘ï¼ŒContext é‡Œæ ¹æ®ç‰ˆæœ¬è£…é…ä¸åŒçš„ State å¯¹è±¡ï¼š

```cpp
// IVersionedStateMachine å®šä¹‰â€œç‰ˆæœ¬åŒ–çŠ¶æ€æœºâ€æ¥å£
class IVersionedStateMachine {
public:
    virtual void onEvent(State&, Event) = 0;
    virtual ~IVersionedStateMachine() = default;
};

// V1 å®ç°
class FSMV1 : public IVersionedStateMachine {
public:
    void onEvent(State& s, Event e) override {
        // V1 ç‰¹æœ‰é€»è¾‘
    }
};

// V2 å®ç°
class FSMV2 : public IVersionedStateMachine {
public:
    void onEvent(State& s, Event e) override {
        // V2 ç‰¹æœ‰é€»è¾‘
    }
};

// å®¢æˆ·ç«¯å·¥å‚
std::unique_ptr<IVersionedStateMachine> makeFSM(Version ver) {
    if (ver == Version::V1) return std::make_unique<FSMV1>();
    else                return std::make_unique<FSMV2>();
}

// ä½¿ç”¨
auto fsm = makeFSM(userConfig.version);
fsm->onEvent(currentState, evt);
```

* **ä¼˜ç‚¹**ï¼š

  * å„ç‰ˆæœ¬ä»£ç è§£è€¦ï¼Œé€»è¾‘æ¸…æ™°ï¼›
  * æ”¯æŒæŒ‰æ’ä»¶ã€SO åŠ¨æ€åŠ è½½ç‰ˆæœ¬æ¨¡å—ï¼›
* **ç¼ºç‚¹**ï¼š

  * éœ€ç¼–å†™å¤šä¸ªç±»ï¼Œç‰ˆæœ¬å¢å¤šæ—¶ç±»æ•°é‡çº¿æ€§å¢é•¿ã€‚

---

## 3. é€‚é…å™¨ï¼ˆAdapterï¼‰+ å…±äº«æ ¸å¿ƒ

å¦‚æœä¸¤ä¸ªç‰ˆæœ¬åªæœ‰â€œå°‘é‡å·®å¼‚â€ï¼Œå¯ä»¥æå–å¤§éƒ¨åˆ†å…±æœ‰é€»è¾‘åˆ°ä¸€å¥—æ ¸å¿ƒå®ç°ï¼Œç„¶åç”¨ Adapter å±‚åšå°èŒƒå›´è°ƒæ•´ï¼š

```cpp
// æ ¸å¿ƒçŠ¶æ€æœº
class CoreFSM {
public:
    void onEvent(State& s, Event e) {
        // å¤§éƒ¨åˆ†é€šç”¨é€»è¾‘
    }
};

// ç‰ˆæœ¬é€‚é…å™¨
class FSMAdapterV2 {
public:
    FSMAdapterV2() : core_() {}
    void onEvent(State& s, Event e) {
        // V2 å‰å¤„ç†
        if (specialCase(s, e)) { /* V2 ä¸“å± */ return; }
        core_.onEvent(s, e);
        // V2 åå¤„ç†
    }
private:
    CoreFSM core_;
};
```

* **ä¼˜ç‚¹**ï¼šæœ€å¤§åŒ–å¤ç”¨æ ¸å¿ƒé€»è¾‘ï¼Œåªåœ¨å¿…è¦å¤„æ’å…¥å·®å¼‚ï¼›
* **ç¼ºç‚¹**ï¼šéœ€è¦ä»”ç»†åˆ’åˆ†å‰åå¤„ç†ç‚¹ã€‚

---

## 4. ç»´åº¦æ‰©å±•ï¼šä¸‰ç»´çŠ¶æ€æœº

å½“ä½ è§‰å¾—å†ä¹Ÿä¸æƒ³å†™â€œä¸¤ä¸ªè¡¨â€ï¼Œå¯ä»¥ç›´æ¥æŠŠç‰ˆæœ¬å½“æˆç¬¬ä¸‰ç»´ï¼ŒæŠŠ key ä» `(State,Event)` æ‰©å±•æˆ `(Version,State,Event)`ï¼Œç„¶åä¸€å¼ è¡¨æå®šï¼š

```cpp
using Key = std::tuple<Version,State,Event>;
std::map<Key, Transition> bigTable = {
    {{V1, A, ev1}, {B, actionV1_AB}},
    {{V2, A, ev1}, {C, actionV2_AC}},  // V2 åœ¨åŒä¸€ä¸ªäº‹ä»¶ä¸‹èµ°ä¸åŒåˆ†æ”¯
    // â€¦
};

void onEvent(Version ver, State& s, Event e) {
    auto it = bigTable.find({ver, s, e});
    if (it != bigTable.end()) {
        it->second.action();
        s = it->second.next;
    }
}
```

* **ä¼˜ç‚¹**ï¼šä¸€å¼ è¡¨ï¼Œé›†ä¸­ç®¡ç†ï¼›
* **ç¼ºç‚¹**ï¼šå¯è¯»æ€§ç¨å·®ã€è¡¨ä¼šæ›´å¤§ã€‚

---

## 5. åŠ¨æ€æ’ä»¶ï¼å¾®æœåŠ¡

å¦‚æœç‰ˆæœ¬å·®å¼‚éå¸¸å¤§ã€ä¸æ–¹ä¾¿åœ¨ä¸€è¿›ç¨‹å†…åŒæ—¶åŠ è½½ï¼Œå¯è€ƒè™‘ï¼š

* **åŠ¨æ€æ’ä»¶**ï¼šæ¯ä¸ªç‰ˆæœ¬åšæˆ `.so`ï¼`.dll`ï¼Œè¿è¡Œæ—¶ `dlopen` åŠ è½½å¯¹åº”ç‰ˆæœ¬çš„å®ç°ï¼›
* **å¾®æœåŠ¡**ï¼šå„ç‰ˆæœ¬è¿è¡Œåœ¨ä¸åŒæœåŠ¡ï¼Œé€šè¿‡ RPC è°ƒç”¨ï¼Œè®©ç‰ˆæœ¬å…¼å®¹å½»åº•è§£è€¦ã€‚

---

### å¦‚ä½•é€‰ï¼Ÿ

1. **å·®å¼‚å¤§å°**ï¼š

   * å·®å¼‚å°‘â†’Adapter + è¡¨é©±åŠ¨ï¼›
   * å·®å¼‚ä¸­ç­‰â†’ç­–ç•¥æ¨¡å¼æˆ–å¤šè¡¨ï¼›
   * å·®å¼‚å·¨å¤§â†’æ’ä»¶æˆ–æœåŠ¡æ‹†åˆ†ã€‚

2. **æ‰©å±•é¢‘ç‡**ï¼š

   * å°‘é‡ç‰ˆæœ¬ã€å¶å°”å‡ºæ–°ç‰ˆæœ¬â†’ç±»ï¼‹ç­–ç•¥ï¼›
   * é¢‘ç¹å‘å¸ƒå¤šä¸ªç‰ˆæœ¬â†’æ•°æ®ï¼‹é…ç½®è¡¨ã€‚

3. **è¿ç»´ï¼æµ‹è¯•**ï¼š

   * è¡¨é©±åŠ¨+é…ç½®åŒ–ï¼Œå¯åœ¨çº¿ç°åº¦ã€å›æ»šæ›´æ–¹ä¾¿ï¼›
   * ç±»æ–¹æ¡ˆéœ€é‡ç¼–è¯‘ã€å›å½’æµ‹è¯•æˆæœ¬é«˜ã€‚

---

**å°ç»“**ï¼š

* å¦‚æœåªæ˜¯â€œå¤šä¸€ä¸ªç‰ˆæœ¬â€ï¼Œæœ€ç®€å•çš„åšæ³•æ˜¯åœ¨åŸæ¥çš„è¡¨é©±åŠ¨æˆ–çŠ¶æ€æ¨¡å¼åŸºç¡€ä¸Šï¼Œå¤šä¸€å¼ ç‰ˆæœ¬å¯¹åº”çš„è¡¨æˆ–çŠ¶æ€å®ç°ï¼›
* å¦‚æœâ€œç‰ˆæœ¬å·®å¼‚è½»é‡â€ï¼Œæå–å…±æ€§é€»è¾‘ï¼Œç”¨ Adapter/é’©å­åœ¨å‰åæ’å…¥å·®å¼‚ï¼›
* è‹¥â€œç‰ˆæœ¬å·®å¼‚å·¨å¤§â€ï¼Œåˆ™æŠŠä¸åŒç‰ˆæœ¬å½»åº•æ‹†æˆæ’ä»¶ï¼å¾®æœåŠ¡ã€‚

é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œä½ å°±èƒ½åœ¨ C++ é‡Œä¼˜é›…åœ°æ”¯æŒå¤šç‰ˆæœ¬ã€é¿å…å¤§é‡ç¡¬ç¼–ç ï¼Œåˆä¿æŒå¯ç»´æŠ¤æ€§ä¸å¯æ‰©å±•æ€§ã€‚
