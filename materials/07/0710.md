// outer_module.h
namespace xxx {

void LogOuter(int line, string func, int err);

void LogFile(int line, string func, int err);

int GetNewErr(int err);
}

#define LOG(errCode) xxx::LogOuter(__LINE__, __FUNCTION__, errCode)
#define LOG_PERMENENT(errCode) xxx::LogFile(__LINE__, __FUNCTION__, errCode)

// cur.h

#define LOG1(cond, err) \
do {
    if (cond) {
        int errCOde = xxx::GetNewErr(err);
        LOG_PERMENENT(errCode);
        LOG(err);
    }
} while (0)


#define LOG2(cond, err) \
do {
    if (cond) {
        LOG(err);
    }
} while (0)


ä½ æä¾›çš„è¿™ä¸ªå®ç»“æ„å¾ˆå…¸å‹ï¼Œå®ƒçš„é—®é¢˜åœ¨äºï¼š

1. **å®è€¦åˆäº†å…·ä½“å®ç° `xxx::LogOuter/LogFile/GetNewErr`**ï¼Œä»»ä½•æ–‡ä»¶åªè¦ç”¨äº† `LOG1/LOG2`ï¼Œå°±å¿…é¡» `#include outer_module.h`ã€‚
2. ç”±äºä½¿ç”¨äº† `__LINE__`, `__FUNCTION__`ï¼Œè¿™äº›æ— æ³•å°è£…ä¸ºå‡½æ•°å‚æ•°ï¼Œåªèƒ½é€šè¿‡å®ä¿ç•™ã€‚
3. å®ä¸æ˜“æµ‹è¯•/è°ƒè¯•ï¼Œä¸æ”¯æŒç±»å‹æ£€æŸ¥ï¼Œä¸æ”¯æŒå‘½åç©ºé—´ã€‚

---

## âœ… è§£è€¦æ€è·¯ç›®æ ‡

### âœ… ä¿ç•™åŠŸèƒ½ï¼ˆ**LINE**, **FUNCTION**ï¼Œæ¡ä»¶åˆ¤æ–­ï¼‰

### âœ… å‡å°‘å¤–éƒ¨å¯¹ `xxx` å‘½åç©ºé—´çš„ä¾èµ–

### âœ… æ¨¡å—é—´å¯æ’æ‹”ï¼šLOG1/LOG2 ä½¿ç”¨è€…æ— éœ€çŸ¥é“ `xxx::LogOuter` æ˜¯è°

### âœ… å¯æµ‹è¯• / å¯æ‰©å±•

---

## ğŸ›  è§£è€¦æ–¹æ¡ˆä¸€ï¼š**å°è£…ä¸ºç‹¬ç«‹ Logger æ¥å£ï¼ˆæ¨èï¼‰**

### ğŸ”¸ Step 1ï¼šå®šä¹‰æŠ½è±¡æ¥å£ï¼Œæä¾›æ—¥å¿—å‡½æ•°

```cpp
// log_interface.h
#pragma once
#include <string>

struct LogContext {
    int line;
    const char* func;
    int errCode;
};

class ILogger {
public:
    virtual ~ILogger() = default;

    virtual void Log(const LogContext& ctx) = 0;
    virtual void LogPermanent(const LogContext& ctx) = 0;
    virtual int GetNewErr(int errCode) = 0;
};
```

---

### ğŸ”¸ Step 2ï¼šè®¾ç½®å…¨å±€ logger å®ä¾‹

```cpp
// log_api.h
#pragma once
#include "log_interface.h"

void SetLogger(ILogger* logger);
ILogger* GetLogger();
```

```cpp
// log_api.cpp
#include "log_api.h"

static ILogger* g_logger = nullptr;

void SetLogger(ILogger* logger) {
    g_logger = logger;
}
ILogger* GetLogger() {
    return g_logger;
}
```

---

### ğŸ”¸ Step 3ï¼šé‡æ„å®é€»è¾‘ï¼Œåˆ†ç¦» `xxx` çš„ä¾èµ–

```cpp
// log_macros.h
#pragma once
#include "log_api.h"

#define LOG(errCode) \
    do { \
        if (auto logger = GetLogger()) { \
            LogContext ctx{__LINE__, __FUNCTION__, errCode}; \
            logger->Log(ctx); \
        } \
    } while (0)

#define LOG_PERMANENT(errCode) \
    do { \
        if (auto logger = GetLogger()) { \
            LogContext ctx{__LINE__, __FUNCTION__, errCode}; \
            logger->LogPermanent(ctx); \
        } \
    } while (0)

#define LOG1(cond, err) \
    do { \
        if ((cond)) { \
            if (auto logger = GetLogger()) { \
                int errCode = logger->GetNewErr(err); \
                LOG_PERMANENT(errCode); \
                LOG(err); \
            } \
        } \
    } while (0)

#define LOG2(cond, err) \
    do { \
        if ((cond)) { \
            LOG(err); \
        } \
    } while (0)
```

---

### ğŸ”¸ Step 4ï¼šåŸå§‹ `xxx` æ¨¡å—å˜æˆä¸€ä¸ªå®ç°ä½“

```cpp
// xxx_logger_impl.h
#pragma once
#include "log_interface.h"
#include <iostream>

class XxxLogger : public ILogger {
public:
    void Log(const LogContext& ctx) override {
        std::cout << "[LOG] " << ctx.func << ":" << ctx.line << " err=" << ctx.errCode << "\n";
    }

    void LogPermanent(const LogContext& ctx) override {
        std::cerr << "[PERM] " << ctx.func << ":" << ctx.line << " err=" << ctx.errCode << "\n";
    }

    int GetNewErr(int err) override {
        return err + 1000;
    }
};
```

```cpp
// main.cpp
#include "log_macros.h"
#include "xxx_logger_impl.h"

int main() {
    XxxLogger logger;
    SetLogger(&logger);

    LOG1(true, 42);  // æ­£å¸¸ä½¿ç”¨
    LOG2(true, 43);
}
```

---

## âœ… æ•ˆæœæ€»ç»“

| ç›®æ ‡                         | å®ç°æƒ…å†µ                                |
| -------------------------- | ----------------------------------- |
| âœ… è§£è€¦å®å’Œå…·ä½“æ—¥å¿—æ¨¡å—               | âœ”ï¸ `log_macros.h` ä¸­ä¸å†ä¾èµ– `xxx`       |
| âœ… æ”¯æŒå¤šä¸ª logger å®ç°           | âœ”ï¸ ä»»æ„å®ç° `ILogger` å³å¯                |
| âœ… æ”¯æŒæµ‹è¯•æ›¿æ¢                   | âœ”ï¸ UT å¯ mock `ILogger`              |
| âœ… ä¿ç•™ **LINE**/**FUNCTION** | âœ”ï¸ åœ¨å®ä¸­ç”Ÿæˆä¼ å…¥ä¸Šä¸‹æ–‡                       |
| âœ… ä½¿ç”¨è€…å¤´æ–‡ä»¶è½»é‡                 | âœ”ï¸ åªéœ€è¦ `log_macros.h` å’Œ `log_api.h` |

---

## ğŸ§© è¡¥å……æ–¹æ¡ˆäºŒï¼šåªåšç®€å•æ¥å£æ¡¥æ¥ï¼ˆé€‚åˆä¸æƒ³é‡æ„å¤ªå¤šï¼‰

å¦‚æœä½ **ä¸æƒ³å¼•å…¥æ¥å£ç±»**ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ä¸€ä¸ªä¸­é—´æ¡¥æ¥å‡½æ•°æ›¿ä»£å®ä¸­çš„ `xxx::`ï¼š

```cpp
// log_adapter.h
#pragma once

namespace log_adapter {
    void log(int line, const char* func, int err);
    void logPermanent(int line, const char* func, int err);
    int getNewErr(int err);
}
```

```cpp
#define LOG(errCode) log_adapter::log(__LINE__, __FUNCTION__, errCode)
#define LOG_PERMANENT(errCode) log_adapter::logPermanent(__LINE__, __FUNCTION__, errCode)
```

ç„¶ååœ¨ `log_adapter.cpp` ä¸­ include åŸ `xxx` å¹¶è½¬å‘ï¼š

```cpp
#include "outer_module.h"

namespace log_adapter {
    void log(int line, const char* func, int err) {
        xxx::LogOuter(line, func, err);
    }
    void logPermanent(int line, const char* func, int err) {
        xxx::LogFile(line, func, err);
    }
    int getNewErr(int err) {
        return xxx::GetNewErr(err);
    }
}
```

> âœ… ä¼˜ç‚¹ï¼šç®€å•å¯è¡Œï¼Œä¸éœ€è¦æ¥å£æŠ½è±¡
> âŒ ç¼ºç‚¹ï¼šä»ç„¶æ— æ³•åŠ¨æ€æ›¿æ¢ loggerï¼Œä¸æ”¯æŒå¤šç§å®ç°ï¼Œä¸é€‚åˆé•¿æœŸæ¼”åŒ–

---

## âœ… æ€»ç»“

### ğŸš€ æ¨èè§£è€¦æ–¹æ¡ˆï¼šå¼•å…¥æ¥å£ `ILogger` + ä¸Šä¸‹æ–‡å¯¹è±¡ `LogContext`

* `å® -> è½»é‡ wrapper`ï¼Œè°ƒç”¨ `GetLogger()` åŠ¨æ€è°ƒåº¦
* è§£è€¦ `xxx::LogXXX` çš„ä¾èµ–
* æ”¯æŒæµ‹è¯•ã€æ’ä»¶åŒ–ã€æ¨¡å—æ‹†åˆ†

---

å¦‚æœä½ å¸Œæœ›æˆ‘ç›´æ¥å¸®ä½ **ç”Ÿæˆä¸€ä¸ªå¯è¿è¡Œçš„å®Œæ•´ä¾‹å­å·¥ç¨‹ç»“æ„**ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šæŒ‰ `.h/.cpp` æ–‡ä»¶æ–¹å¼å†™å‡ºæ¥ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

éå¸¸å¥½çš„é—®é¢˜ï¼

> ğŸ”¥ å½“å®ä¸­æ¶‰åŠ\*\*å˜é•¿å‚æ•°ï¼ˆvariadic argumentsï¼‰\*\*æ—¶ï¼Œè§£è€¦ä¼šæ›´å¤æ‚ï¼Œå› ä¸ºï¼š
>
> * `__VA_ARGS__` æ˜¯å®ç‰¹æœ‰çš„ç‰¹æ€§ï¼Œinline å‡½æ•°æˆ–ç±»æ— æ³•ç›´æ¥æ›¿ä»£ï¼›
> * `__LINE__` / `__FUNCTION__` ä¹Ÿå¿…é¡»ä¿ç•™åœ¨å®å±‚ï¼›
> * è§£è€¦åä»éœ€å…¼å®¹æ ¼å¼åŒ–é£æ ¼ï¼ˆå¦‚ `printf`-styleï¼‰æ—¥å¿—ã€‚

---

## âœ… æ ¸å¿ƒç›®æ ‡ï¼š

**ä¿ç•™å®è¯­æ³•ä½“éªŒï¼ˆ`LOG("msg %d", val)`ï¼‰çš„åŒæ—¶ï¼Œå®ç°åº•å±‚è§£è€¦**

---

## ğŸ¯ ç¤ºä¾‹ï¼šåŸå§‹å˜å‚å®

```cpp
// outer_module.h
namespace xxx {
    void LogOuterV(int line, const char* func, const char* fmt, ...);
}

#define LOG(fmt, ...) \
    xxx::LogOuterV(__LINE__, __FUNCTION__, fmt, ##__VA_ARGS__)
```

---

## âœ… è§£è€¦æ–¹æ¡ˆï¼šå°è£…åº•å±‚ä¸º `vprintf` é£æ ¼å‡½æ•° + æä¾›å®å…¥å£

---

### ğŸ§© Step 1ï¼šä½¿ç”¨ `va_list` çš„å¯å˜å‚æ•°æ¥å£

```cpp
// log_interface.h
#pragma once
#include <cstdarg>

class ILogger {
public:
    virtual ~ILogger() = default;
    virtual void Log(int line, const char* func, const char* fmt, va_list args) = 0;
};
```

---

### ğŸ§© Step 2ï¼šç»Ÿä¸€ `LogApi` å¯¹å¤–æš´éœ² V å½¢å¼å‡½æ•°

```cpp
// log_api.h
#pragma once
#include "log_interface.h"

void SetLogger(ILogger* logger);
ILogger* GetLogger();

inline void LogV(int line, const char* func, const char* fmt, va_list args) {
    if (auto logger = GetLogger()) {
        logger->Log(line, func, fmt, args);
    }
}

// å¯é€‰åŒ…è£…å‡½æ•°
inline void Log(int line, const char* func, const char* fmt, ...) {
    va_list args;
    va_start(args, fmt);
    LogV(line, func, fmt, args);
    va_end(args);
}
```

---

### ğŸ§© Step 3ï¼šå®šä¹‰æ–°çš„å®å…¥å£

```cpp
// log_macros.h
#pragma once
#include "log_api.h"

#define LOG(fmt, ...) \
    Log(__LINE__, __FUNCTION__, fmt, ##__VA_ARGS__)
```

âœ… ä½¿ç”¨æ—¶ä»ä¿æŒåŸä½“éªŒï¼š

```cpp
LOG("error code: %d", errCode);
```

---

### ğŸ§© Step 4ï¼šåº•å±‚æ—¥å¿—æ¨¡å—é€‚é… `ILogger`

```cpp
// xxx_logger_impl.h
#pragma once
#include "log_interface.h"
#include <cstdio>

class XxxLogger : public ILogger {
public:
    void Log(int line, const char* func, const char* fmt, va_list args) override {
        std::fprintf(stderr, "[%s:%d] ", func, line);
        std::vfprintf(stderr, fmt, args);
        std::fprintf(stderr, "\n");
    }
};
```

---

## âœ… æ•ˆæœ

| é¡¹                                                | è¯´æ˜ |
| ------------------------------------------------ | -- |
| âœ… å®ä¸­ä¿ç•™ `__LINE__`, `__FUNCTION__`, `__VA_ARGS__` | âœ”  |
| âœ… æ”¯æŒ printf é£æ ¼æ—¥å¿—                                 | âœ”  |
| âœ… æ¥å£ ILogger æ— éœ€åŒ…å«ä»»ä½•å®è¯­æ³•                           | âœ”  |
| âœ… ä½¿ç”¨è€…æ— æ„ŸçŸ¥ï¼ˆæ— å¤–éƒ¨ä¾èµ– xxxï¼‰                              | âœ”  |
| âœ… å¯ä»¥æ›¿æ¢å®ç°ï¼Œæ¯”å¦‚è½¬å†™æˆ JSONã€å†™æ–‡ä»¶ç­‰                         | âœ”  |

---

## ğŸš« ä¸æ¨èæ–¹æ¡ˆï¼ˆå¸¸è§è¯¯åŒºï¼‰

| é”™è¯¯æ–¹å¼               | é—®é¢˜                                    |
| ------------------ | ------------------------------------- |
| ç”¨å‡½æ•°æ¨¡æ¿+`...`å‚æ•°åŒ…æ›¿ä»£å®  | æ— æ³•ä¿ç•™ `__LINE__`, `__FUNCTION__` çš„è‡ªåŠ¨ä¼ å‚ |
| åœ¨å‡½æ•°ä¸­ç›´æ¥ç”¨ `...` å¯å˜å‚æ•° | éœ€è¦æ ¼å¼å’Œå‚æ•°æ˜¾å¼ä¼ å…¥ï¼Œä¸æ”¯æŒè½¬å‘                     |

---

## âœ… æ€»ç»“

| æŠ€æœ¯ç‚¹                         | è¯´æ˜            |
| --------------------------- | ------------- |
| `__VA_ARGS__` å®å˜å‚           | åªèƒ½ä¿ç•™åœ¨å®ä¸­       |
| `va_list` æ¥å£                | ç”¨äº C++ å‡½æ•°æ¥æ”¶å˜å‚ |
| `vfprintf`ã€`vsnprintf`      | å¸¸ç”¨äºåº•å±‚æ—¥å¿—æ ¼å¼è¾“å‡º   |
| `ILogger::Log(... va_list)` | æ˜¯å‡½æ•°å±‚è§£è€¦çš„å…³é”®æ–¹å¼   |

---

### ğŸ“¦ Bonusï¼šæ˜¯å¦éœ€è¦æˆ‘ç”Ÿæˆä¸€ä¸ªå®Œæ•´ demo å·¥ç¨‹ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼Ÿ

* `log_macros.h` ä½¿ç”¨ `LOG(...)` å®
* `ILogger` æ¥å£å®šä¹‰
* `log_api` å…¨å±€æ³¨å†Œæœºåˆ¶
* `XxxLogger` çš„å…·ä½“å®ç°
* ä¸€ä¸ª `main.cpp` ç¤ºä¾‹è¿è¡Œå…¥å£

ä½ åªéœ€ copy/paste å³å¯è¿è¡Œã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

